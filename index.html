<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Kompass Lead Daily Checklist</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    html {
        scroll-behavior: smooth;
    }
    
</style>


<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

        /* --- NEW LOADING OVERLAY STYLE --- */
        .loading-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10000;
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            backdrop-filter: blur(5px);
        }
        .loading-overlay.show {
            display: flex;
        }
        /* --- END NEW STYLE --- */

        .container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            .container {
                max-width: 95%;
            }
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                border-radius: 10px;
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .header-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }

        .input-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: white;
        }

        .header-info input {
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            width: 100%;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.2);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            min-width: 0;
            white-space: nowrap;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
            transition: opacity 0.2s ease;
        }

        .section-header:hover {
            opacity: 0.9;
        }

        .section-header:active {
            opacity: 0.8;
        }

        .section-content {
            padding: 20px;
            background: #fafafa;
        }
        
        /* --- NEW STYLE FOR BOTTOM COLLAPSE BUTTON --- */
        /* --- This style block has been removed as it's no longer needed --- */
        /* --- END NEW STYLE --- */

        .checklist-item {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .checklist-item.completed {
            border-left-color: #56ab2f;
            opacity: 0.7;
        }

        .item-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .checkbox-wrapper {
            flex-shrink: 0;
            padding-top: 2px;
        }

        input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #667eea;
            flex-shrink: 0;
        }

        .item-content {
            flex-grow: 1;
        }

        .item-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .item-description {
            color: #666;
            line-height: 1.6;
        }

        .item-description ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .item-description li {
            margin-bottom: 5px;
        }

        .eod-field {
            margin: 10px 0;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 5px;
            border-left: 3px solid #2196F3;
        }

        .eod-field label {
            display: block;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .eod-field input[type="text"],
        .eod-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.95em;
        }

        .eod-field textarea {
            min-height: 60px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 8px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .checkbox-option label {
            font-weight: 600;
            color: #333;
            cursor: pointer;
        }

        .signature-section {
            margin: 30px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .signature-label {
            font-weight: 600;
            font-size: 1em;
            display: block;
            margin-bottom: 10px;
            color: #667eea;
        }

        .signature-canvas {
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            cursor: crosshair;
            display: block;
            width: 100%;
            height: 150px;
            touch-action: none;
        }

        .btn-clear-sig {
            margin-top: 10px;
            padding: 10px 20px;
            background: #667eea;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
            color: white;
            font-weight: 600;
        }

        .btn-clear-sig:hover {
            background: #764ba2;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        .notes-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }

        .notes-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .notes-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
        }

        .email-list {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .email-list h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .email-list ul {
            list-style: none;
            margin-left: 0;
        }

        .email-list li {
            color: #0d47a1;
            padding: 3px 0;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
        }

        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px 5px;
            }

            .container {
                border-radius: 10px;
                max-width: 100%;
            }

            .header {
                padding: 15px 12px;
            }

            .header h1 {
                font-size: 1.3em;
                margin-bottom: 12px;
            }

            .header-row {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 12px;
            }

            .input-group label {
                font-size: 0.8em;
                margin-bottom: 3px;
            }

            .header-info input,
            .input-group input {
                padding: 10px;
                font-size: 1em;
                width: 100%;
            }

            .progress-bar-container {
                margin-top: 15px;
                height: 25px;
            }

            .content {
                padding: 15px 12px;
            }

            .section-header {
                padding: 12px 15px;
                font-size: 1.1em;
            }

            .section-content {
                padding: 12px;
            }

            .checklist-item {
                padding: 12px;
                margin-bottom: 12px;
            }

            .item-header {
                gap: 12px;
            }

            .item-title {
                font-size: 1em;
            }

            .item-description {
                font-size: 0.9em;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                padding: 14px 20px;
            }

            .checkbox-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .email-list {
                padding: 12px;
            }

            .notes-section {
                padding: 15px;
            }

            .signature-section {
                padding: 15px;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
            }

            .header {
                background: white;
                color: black;
                border-bottom: 3px solid #667eea;
            }

            .section-header {
                background: white;
                color: #667eea;
                border: 2px solid #667eea;
                page-break-after: avoid;
            }
            
            /* --- Hide bottom collapse button when printing --- */
            .section-footer-collapse {
                display: none;
            }

            .section-content {
                page-break-inside: avoid;
            }

            .checklist-item {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #e0e0e0;
            }

            .button-group,
            .signature-section {
                display: none;
            }

            .progress-bar-container {
                border: 2px solid #667eea;
            }

            .notes-section {
                page-break-inside: avoid;
            }
            
            @page {
                size: letter;
                margin: 0.35in 0.4in;
            }
        }

        /* Ensure inputs are touch-friendly on mobile */
        @media (hover: none) and (pointer: coarse) {
            input, textarea, button {
                font-size: 16px !important;
            }

            input[type="checkbox"] {
                width: 24px;
                height: 24px;
                min-width: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>KOMPASS LEAD DAILY CHECKLIST</h1>
            
            <!-- Single Row: Store, Date, Lead Name -->
            <div class="header-row">
                <div class="input-group">
                    <label>Store #:</label>
                    <input type="text" id="storeNumber" placeholder="Enter store number">
                </div>
                <div class="input-group">
                    <label>Date:</label>
                    <input type="date" id="workDate">
                </div>
                <div class="input-group">
                    <label>Lead Name:</label>
                    <input type="text" id="leadName" placeholder="Enter your name">
                </div>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
            </div>
        </div>
        <div class="section-controls">
            <button class="btn btn-secondary btn-sm" onclick="expandAllSections()" title="Expand all sections">Expand All</button>
            <button class="btn btn-secondary btn-sm" onclick="collapseAllSections()" title="Collapse all sections">Collapse All</button>
        </div>
        <div class="content">
            <!-- Section 1: Pre-Work Setup -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>PRE-WORK SETUP</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="checklist-item" data-id="item-0">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.0 Review Communications</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Read and understand all emails from your supervisor</li>
                                        <li>Review any store issue emails</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-1">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.1 Access the "Dump Bin"</div>
                                <div class="item-description">
                                    Your information hub for everything Kompass-related:
                                    <ul>
                                        <li>Navigate to your period/week folder</li>
                                        <li>Review "Considerations" and "Test Set Notes"</li>
                                        <li>Review "Inventory Schedule" and "Strip Installation" dates</li>
                                        <li>Review "Final Kompass Notes" (deleted items, new items, UPC changes, set instructions)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-2">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.2 Download & "Fax" Print Weekly Materials</div>
                                <div class="item-description">
                                    You can send a fax via email to get your documents printed at the store:
                                    <ul>
                                        <li>Download Kompass Notes, Sign-off Sheets, EOD Cover Sheet, backstock and "Not in Set" labels</li>
                                        <li>Email to: <strong>tyson.gauthier@retailodyssey.com</strong></li>
                                        <li>Subject Line: <strong>#StoreNumber</strong> (e.g., #163) - nothing else</li>
                                        <li>Attach documents and send</li>
                                        <li>Wait for confirmation email to pick up at customer service desk</li>
                                        <li>Alternatively: Use subject line <strong>Fax#</strong> followed by the fax number, for example <strong>Fax#18885551234</strong> (include country code)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-3">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.3 Review Schedule in PROD</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Review your schedule before leaving home</li>
                                        <li>Confirm store addresses, directions, and start times</li>
                                        <li>Ensure that you have all materials, notes, and tools required</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-4">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.4 Professional Preparation</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Wear your name tag and Retail Odyssey work shirt</li>
                                        <li>Park at least half a dozen spaces from the store entrance (leave prime parking for customers)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-5">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.5 Arrive Early & Coordinate Entry</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Arrive at least 1 hour before the team</li>
                                        <li>Coordinate with store personnel for early entry</li>
                                        <li>Typically, we use the grocery receiving door at the back of the building.</li>
                                        <li>Get organized and review the day's plan</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-6">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.6 Locate the Kompass Box & Take Kompass Cart Photo <span style="color: #f39c12; font-weight: bold;">EOD</span></div>
                                <div class="item-description">
                                    <ul>
                                        <li>White box with blue lettering containing label strips</li>
                                        <li>Check: price change room, office, Kompass cart, receiver's desk</li>
                                        <li>If missing: Use "Vestcom Box Tracking" file in dump bin</li>
                                        <li>While at the cart, take a "before" photo in PROD (Maintenance category) of the Kompass cart, before work starts</li>
                                    </ul>

                                    <div class="eod-field">
                                        <label>Before picture of KOMPASS cart loaded to KOMPASS Maintenance line?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodBeforePhotoYes" name="beforePicPosted" value="Yes" onchange="toggleRadio('beforePicPosted')">
                                                <label for="eodBeforePhotoYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodBeforePhotoNo" name="beforePicPosted" value="No" onchange="toggleRadio('beforePicPosted')">
                                                <label for="eodBeforePhotoNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-7">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.7 Organize Strips, Planograms & Materials</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Arrange strips and planograms on check stand or preferred area</li>
                                        <li>Speak with the head cashier (red vest) about using the space and when to move</li>
                                        <li>Use the strip manifest to record the aisle number on the front of the planogram</li>
                                        <li>Separate and organize POGs and strips, and include the UPLs/price tags</li>
                                        <li>Confirm they are for the correct store number</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-8">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.8 Report No Shows by 7:00 AM</div>
                                <div class="item-description">
                                    Report any no-calls/no-shows to your supervisor by 7:00 AM
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-9">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.9 Report Missing COMs (Commodities) by 7:00 AM</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Report categories that are missing from PROD to your supervisor by 7:00 AM</li>
                                        <li>Ensure you cross-reference any remodel projects or strip installations occurring at that store by accessing the folder in the dump bin</li>
                                        <li>Your supervisor may have provided you with this information verbally or in an email.</li>
                                        <li>Ensure you provide your supervisor with the category number, the category name, the version number, the footage, and the DBKey</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Collapse Button at the bottom (This has been removed and will be added by JavaScript) -->
                </div>
            </div>

            <!-- Section 2: During Work -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>DURING WORK</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="checklist-item" data-id="item-10">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.0 Complete Required Surveys First</div>
                                <div class="item-description">
                                    Complete all surveys that aren't directly linked to a set being reset on the first morning of each store visit
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-11">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.1 Check In with PIC by 7:00 AM and Record Name <span style="color: #f39c12; font-weight: bold;">EOD</span></div>
                                <div class="item-description">
                                    Check in with the person in charge (PIC) by 7:00 AM and record their name
                                    
                                    <div class="eod-field">
                                        <label>Manager's name you checked in with:</label>
                                        <input type="text" id="checkInManager" placeholder="Enter manager's name">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-12">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.2 Take "Before" Pictures of All Sets in PROD</div>
                                <div class="item-description">
                                    Take before pictures of all sets in PROD immediately after assigning first sets
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-13">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.3 Plan the Day Strategically</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Assign and start priority sets in order: cut-ins, fresh/fuel sets, then largest backlog sets</li>
                                        <li>Once priority and backlog sets are complete, begin current sets</li>
                                        <li>Identify large/time-intensive sets from Kompass Notes</li>
                                        <li>Contact department heads for coordination</li>
                                        <li>Ask about preferred days/timing (non-load days)</li>
                                        <li><strong>Complete priority and fuel sets first and close them out by 9:00 AM</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-14">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.4 Coordinate with Vendors</div>
                                <div class="item-description">
                                    Notify vendor reps in advance (Coke, Pepsi, Dr. Pepper, Columbia/Frito Lay, Tim's, Mission, etc.)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-15">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.5 Maintain Professional Relationships</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Adjust approach for each store</li>
                                        <li>Build positive relationships with staff</li>
                                        <li>Communicate clearly and respectfully with all personnel</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-16">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.6 Assign Sets Fairly</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Consider experience level, aptitude, and strengths</li>
                                        <li>Avoid favoritism - don't repeatedly assign difficult sets to same person</li>
                                        <li>Assign based on ability, not preference</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-17">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.7 Verify Correct Planogram and Setup</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Verify correct planogram for that store's section and size</li>
                                        <li>Confirm proper number of shelves and shelf heights</li>
                                        <li>Limit to 2 people per 12 feet of set</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-18">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.8 Pull Discontinued Items</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Pull discontinued (DI) items as noted in Kompass Notes and planograms</li>
                                        <li>Use banana boxes and label clearly with appropriate labels</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-19">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.9 Maintain Shopper-Friendly Aisles</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Keep all carts, ladders, and boxes to one side of the aisle</li>
                                        <li>Work in 4-foot sections to maintain accessibility during store hours</li>
                                        <li>Maintain a clean aisle at all times</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-20">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.10 Remove Old Strips and Install New Ones</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Remove old shelf strips and install new ones per planogram</li>
                                        <li>Replace channel strips/data skins as needed</li>
                                        <li>Set category according to updated planogram</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-21">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.11 Rotate Stock Properly</div>
                                <div class="item-description">
                                    Place older items at the front and newer items at the back
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-22">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.12 Track Time and Manage Workflow</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Keep track of time - monitor progress against schedule</li>
                                        <li>Sets should be completed within time estimations</li>
                                        <li>If set exceeds allotted time: Use comment bubble in PROD and report to supervisor</li>
                                        <li>Explanation must be concise (5 words or less): training, lots of overstock, shelves needed cleaning, etc.</li>
                                        <li>Track participation: Use 1st page of Kompass Notes with initials and times</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-23">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.13 Handle New Items from Kompass Cart</div>
                                <div class="item-description">
                                    Ensure new items are taken from the Kompass cart or other designated new item location
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-24">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.14 Clean Shelving and Hang Tags</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Clean shelving and tag moldings where movement occurs</li>
                                        <li>Hang all tags provided or handwrite missing tags as needed</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-25">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.15 Organize Back Stock</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Back stock should be boxed in banana boxes</li>
                                        <li>Palletize and label clearly</li>
                                        <li>Label "Overstock" and "Not in Set" items with appropriate labels</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-26">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.16 Take "After" Pictures in PROD</div>
                                <div class="item-description">
                                    Take after pictures immediately after each set is fully complete:
                                    <ul>
                                        <li>All strips in, shelves adjusted, tags hung, new items placed</li>
                                        <li>"Overstock" and "Not in Set" items labeled and organized</li>
                                        <li>If a set cannot be completed, the exception needs to be the same in both PROD and SI and there needs to be a comment in the comment bubble in PROD and a mention in your EOD Email</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-27">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.17 Take "After" Photos in Store Intelligence</div>
                                <div class="item-description">
                                    After photos - Immediately after each set is fully complete:
                                    <ul>
                                        <li>Bay by bay for each set take a photo</li>
                                        <li>Clear exceptions through the actions section</li>
                                        <li>Ensure all sets completed in PROD are completed in Store Intelligence</li>
                                        <li><strong>This needs to be done prior to leaving the store</strong></li>
                                        <li>If a set cannot be completed, the exception needs to be the same in both PROD and SI and there needs to be a comment in the comment bubble in PROD and a mention in your EOD Email</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-28">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.18 Sync Tablet Frequently</div>
                                <div class="item-description">
                                    Resync after completing major tasks, surveys, and uploading pictures
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-29">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.19 Handle Issues and Contact Support if Needed <span style="color: #f39c12; font-weight: bold;">EOD</span></div>
                                <div class="item-description">
                                    If problems occur (incorrect planogram, wrong footage, fixture issues, store refusal):
                                    <ul>
                                        <li>First contact your supervisor and inform them of the issue</li>
                                        <li>Get name and title of person refusing the set or details of the issue</li>
                                        <li>Your supervisor may request you contact Kompass support: <strong>kompass@retailodyssey.com</strong> (CC supervisor)</li>
                                    </ul>
                                    
                                    <div class="eod-field">
                                        <label>Did you call or e-mail the KOMPASS Hotline?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodHotlineYes" name="calledHotline" value="Yes" onchange="toggleHotlineFields(this)">
                                                <label for="eodHotlineYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodHotlineNo" name="calledHotline" value="No" onchange="toggleHotlineFields(this)">
                                                <label for="eodHotlineNo">No</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="hotlineDetails" style="display: none;">
                                        <div class="eod-field">
                                            <label>If so, what commodities are involved?</label>
                                            <input type="text" id="issueCommodities" placeholder="Enter commodities">
                                        </div>

                                        <div class="eod-field">
                                            <label>What is the issue?</label>
                                            <textarea id="issueDescription" placeholder="Describe the issue"></textarea>
                                        </div>

                                        <div class="eod-field">
                                            <label>Was the issue resolved before EOD?</label>
                                            <div class="checkbox-group">
                                                <div class="checkbox-option">
                                                    <input type="checkbox" id="eodResolvedYes" name="issueResolved" value="Yes" onchange="toggleResolutionField(this)">
                                                    <label for="eodResolvedYes">Yes</label>
                                                </div>
                                                <div class="checkbox-option">
                                                    <input type="checkbox" id="eodResolvedNo" name="issueResolved" value="No" onchange="toggleResolutionField(this)">
                                                    <label for="eodResolvedNo">No</label>
                                                </div>
                                                <div class="checkbox-option">
                                                    <input type="checkbox" id="eodResolvedNA" name="issueResolved" value="NA" onchange="toggleResolutionField(this)">
                                                    <label for="eodResolvedNA">N/A</label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="eod-field" id="tempSolutionField" style="display: none;">
                                            <label>If not, what was the temporary solution?</label>
                                            <textarea id="tempSolution" placeholder="Describe temporary solution"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-30">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.20 Final Set Verification</div>
                                <div class="item-description">
                                    Confirm the area is left clean, organized, and safe
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Collapse Button at the bottom (This has been removed and will be added by JavaScript) -->
                </div>
            </div>

            <!-- Section 3: End of Day -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>END OF DAY</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="checklist-item" data-id="item-31">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.1 Walk Sets and Complete Sign-Offs <span style="color: #f39c12; font-weight: bold;">EOD</span></div>
                                <div class="item-description">
                                    <ul>
                                        <li>Walk each set with store personnel to verify completion</li>
                                        <li>Show them where you placed overstock/discontinued items</li>
                                        <li>Complete and review Kompass Sign-Off sheets with store representative</li>
                                        <li>Before giving them their copy, take a photo of the sign-off sheet for records</li>
                                        <li>Leave a signed copy with them</li>
                                        <li>Ask them to complete Kompass Completion online</li>
                                        <li>Record the name of the person you checked out with</li>
                                    </ul>

                                    <div class="eod-field">
                                        <label>Manager's name you checked out with:</label>
                                        <input type="text" id="checkOutManager" placeholder="Enter manager's name">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-32">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.2 Complete PROD and SI <span style="color: #f39c12; font-weight: bold;">EOD</span></div>
                                <div class="item-description">
                                    Verify all sets are signed off in both systems
                                    
                                    <div class="eod-field">
                                        <label>Did all sets get signed out in PROD?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodProdYes" name="signedOutPROD" value="Yes" onchange="toggleRadio('signedOutPROD')">
                                                <label for="eodProdYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodProdNo" name="signedOutPROD" value="No" onchange="toggleRadio('signedOutPROD')">
                                                <label for="eodProdNo">No</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="eod-field">
                                        <label>Did all sets get signed out in SI?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodSiYes" name="signedOutSI" value="Yes" onchange="toggleRadio('signedOutSI')">
                                                <label for="eodSiYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodSiNo" name="signedOutSI" value="No" onchange="toggleRadio('signedOutSI')">
                                                <label for="eodSiNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-33">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.3 Sign-Off Sheet Documentation <span style="color: #f39c12; font-weight: bold;">EOD</span></div>
                                <div class="item-description">
                                    Ensure proper documentation of sign-off sheets

                                    <div class="eod-field">
                                        <label>Sign out sheet attached to EOD email?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodEmailSheetYes" name="signoutEmail" value="Yes" onchange="toggleRadio('signoutEmail')">
                                                <label for="eodEmailSheetYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodEmailSheetNo" name="signoutEmail" value="No" onchange="toggleRadio('signoutEmail')">
                                                <label for="eodEmailSheetNo">No</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="eod-field">
                                        <label>Sign out sheet attached to KOMPASS Maintenance line in PROD?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodProdSheetYes" name="signoutPROD" value="Yes" onchange="toggleRadio('signoutPROD')">
                                                <label for="eodProdSheetYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodProdSheetNo" name="signoutPROD" value="No" onchange="toggleRadio('signoutPROD')">
                                                <label for="eodProdSheetNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-34">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.4 Kompass Cart "After" Photos <span style="color: #f39c12; font-weight: bold;">EOD</span></div>
                                <div class="item-description">
                                    Take clear, in-focus photos of Kompass cart

                                    <div class="eod-field">
                                        <label>After picture of KOMPASS cart loaded to KOMPASS Maintenance line?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodAfterPhotoYes" name="afterPicPosted" value="Yes" onchange="toggleRadio('afterPicPosted')">
                                                <label for="eodAfterPhotoYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodAfterPhotoNo" name="afterPicPosted" value="No" onchange="toggleRadio('afterPicPosted')">
                                                <label for="eodAfterPhotoNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-35">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.5 Final Quality Check</div>
                                <div class="item-description">
                                    Verify all pictures are clear, well-lit, in focus, and properly attached
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-36">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.6 Compose the EOD Email</div>
                                <div class="item-description">
                                    <ul>
                                        <li><strong>To:</strong> Fred Meyer PIC + store management</li>
                                        <li><strong>CC:</strong> See email list below</li>
                                        <li><strong>Subject:</strong> EOD FM### MM/DD/YYYY</li>
                                        <li><strong>Attachments:</strong> Quality photos of all Sign-off sheets and EOD Cover Sheet</li>
                                    </ul>
                                    <div class="email-list">
                                        <h4>EOD Email CC List:</h4>
                                        <ul>
                                            <li>mashabranner@retailodyssey.com</li>
                                            <li>seth.newman@retailodyssey.com</li>
                                            <li>knix@retailodyssey.com</li>
                                            <li>yoursupervisor@retailodyssey.com</li>
                                            <li>yourself@retailodyssey.com</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-37">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.7 Final Time Requirements</div>
                                <div class="item-description">
                                    <strong>Ensure that:</strong>
                                    <ul>
                                        <li>All work is completed by <strong>2:30 PM</strong></li>
                                        <li>EOD emails sent by <strong>3:00 PM</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Collapse Button at the bottom (This has been removed and will be added by JavaScript) -->
                </div>
            </div>

            <!-- Notes Section -->
            <div class="notes-section">
                <h3>NOTES & ISSUES:</h3>
                <textarea id="notes" placeholder="Enter any notes, issues, or observations here..."></textarea>
            </div>

            <!-- Signature Section - Moved to the end -->
            <div class="signature-section">
                <label class="signature-label">Lead Signature:</label>
                <canvas id="signaturePad" class="signature-canvas"></canvas>
                <button class="btn-clear-sig" onclick="clearSignature()">Clear Signature</button>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button class="btn btn-success" onclick="generateEODCoverSheet()">Generate EOD Cover Sheet (PDF)</button>
                <button class="btn btn-primary" onclick="generateEODImage()">Generate EOD Image (JPG)</button>
                <button class="btn btn-primary" onclick="saveProgress(event)">Save to Device</button>
                <button class="btn btn-secondary" onclick="resetChecklist()">Reset Checklist</button>
            </div>
        </div>
    </div>

    <!-- NEW LOADING OVERLAY HTML -->
    <div id="loadingOverlay" class="loading-overlay">
        <span>Generating Image, please wait...</span>
    </div>

    <script>
        const PDF_FILE = 'End%20Of%20Day%20Cover%20Sheet%20Form%20Editable%20Template.pdf';
        const pdfUrl = `${PDF_FILE}?v=${(crypto?.randomUUID?.() || Date.now())}`;

        // Set today's date by default
        document.getElementById('workDate').valueAsDate = new Date();

        // Load saved data on page load
        window.onload = function() {
            // Setup PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            loadProgress();
            updateProgress();

            // --- NEW LOGIC FROM USER'S UPLOADED FILE ---
            // Add a bottom-toggle ("Collapse") button to each section content
            document.querySelectorAll('.section').forEach(section => {
                const header = section.querySelector('.section-header');
                const content = section.querySelector('.section-content');
                if (!header || !content) return;

                // Create container for bottom actions
                const bottomWrap = document.createElement('div');
                bottomWrap.style.display = 'flex';
                bottomWrap.style.justifyContent = 'flex-end';
                bottomWrap.style.marginTop = '12px';
                bottomWrap.style.borderTop = '1px solid #eee';
                bottomWrap.style.paddingTop = '12px';

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-secondary section-bottom-toggle';
                btn.style.padding = '8px 16px'; // Make it smaller
                btn.style.fontSize = '0.9em';
                btn.textContent = 'Collapse Section';

                // Add the click listener from user's file
                btn.addEventListener('click', () => {
                    // Call the global toggleSection function
                    toggleSection(header);
                    
                    // Scroll header into view ONLY when collapsing
                    if (section.classList.contains('collapsed')) {
                        header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });

                bottomWrap.appendChild(btn);
                content.appendChild(bottomWrap);
            });

            // Improve visual alignment for checklist items in PRE-WORK section
            const firstSection = document.querySelector('.content .section');
            if (firstSection) {
                firstSection.querySelectorAll('.item-header').forEach(itemHeader => {
                    itemHeader.style.alignItems = 'center';
                });
                firstSection.querySelectorAll('.item-title').forEach(title => {
                    title.style.display = 'block';
                });
            }
            // --- END NEW LOGIC ---
        };

        function toggleSection(header) {
            const section = header.closest('.section'); // Use closest to be safe
            const content = section.querySelector('.section-content');
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                content.style.display = 'none';
            } else {
                content.style.display = 'block';
            }
        }
        
        // --- REPLACED FUNCTIONS for Expand/Collapse All (from user's file) ---
        window.expandAllSections = function() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('collapsed');
                const content = section.querySelector('.section-content');
                if (content) content.style.display = 'block';
            });
        };
        window.collapseAllSections = function() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('collapsed');
                const content = section.querySelector('.section-content');
                if (content) content.style.display = 'none';
            });
        };
        // --- END REPLACED FUNCTIONS ---

        // Radio button simulation - ensure only one checkbox per group is checked
        function toggleRadio(groupName) {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
            const clickedBox = event.target;
            
            checkboxes.forEach(box => {
                if (box !== clickedBox) {
                    box.checked = false;
                }
            });
            
            autoSave();
        }

        function updateProgress() {
            // Get all main checkboxes (not EOD field checkboxes)
            const mainCheckboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]:not([name])');
            let totalItems = mainCheckboxes.length;
            let completedItems = 0;

            mainCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    completedItems++;
                }
            });

            // Add EOD-specific checkboxes/fields to the count
            const eodFields = [
                'beforePicPosted', 'checkInManager', 'calledHotline',
                'checkOutManager', 'signedOutPROD', 'signedOutSI',
                'signoutEmail', 'signoutPROD', 'afterPicPosted'
            ];

            eodFields.forEach(fieldName => {
                if (fieldName === 'checkInManager' || fieldName === 'checkOutManager') {
                    // Text input fields
                    const field = document.getElementById(fieldName);
                    if (field && field.value.trim() !== '') {
                        completedItems++;
                    }
                    totalItems++;
                } else {
                    // Radio button groups
                    const checked = document.querySelector(`input[name="${fieldName}"]:checked`);
                    if (checked) {
                        completedItems++;
                    }
                    totalItems++;
                }
            });

            // Only count hotline details if hotline was called
            const hotlineYes = document.getElementById('eodHotlineYes');
            if (hotlineYes && hotlineYes.checked) {
                const commoditiesField = document.getElementById('issueCommodities');
                const issueField = document.getElementById('issueDescription');
                const resolvedChecked = document.querySelector('input[name="issueResolved"]:checked');

                if (commoditiesField && commoditiesField.value.trim() !== '') completedItems++;
                totalItems++;

                if (issueField && issueField.value.trim() !== '') completedItems++;
                totalItems++;

                if (resolvedChecked) completedItems++;
                totalItems++;

                // Only count temp solution if issue was not resolved
                const resolvedNo = document.getElementById('eodResolvedNo');
                if (resolvedNo && resolvedNo.checked) {
                    const tempSol = document.getElementById('tempSolution');
                    if (tempSol && tempSol.value.trim() !== '') completedItems++;
                    totalItems++;
                }
            }

            const percentage = Math.round((completedItems / totalItems) * 100);
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            // Update completed styling
            mainCheckboxes.forEach(checkbox => {
                const item = checkbox.closest('.checklist-item');
                if (checkbox.checked) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            });

            // Auto-save when checking/unchecking
            autoSave();
        }

        function toggleHotlineFields(checkbox) {
            const yesBox = document.getElementById('eodHotlineYes');
            const noBox = document.getElementById('eodHotlineNo');
            const detailsDiv = document.getElementById('hotlineDetails');
            
            // Toggle mutual exclusivity
            if (checkbox.id === 'eodHotlineYes' && checkbox.checked) {
                noBox.checked = false;
                detailsDiv.style.display = 'block';
            } else if (checkbox.id === 'eodHotlineNo' && checkbox.checked) {
                yesBox.checked = false;
                detailsDiv.style.display = 'none';
            } else if (!yesBox.checked && !noBox.checked) {
                detailsDiv.style.display = 'none';
            }
            
            updateProgress();
            autoSave();
        }

        function toggleResolutionField(checkbox) {
            const yesBox = document.getElementById('eodResolvedYes');
            const noBox = document.getElementById('eodResolvedNo');
            const naBox = document.getElementById('eodResolvedNA');
            const tempField = document.getElementById('tempSolutionField');
            
            // Toggle mutual exclusivity
            if (checkbox.id === 'eodResolvedYes' && checkbox.checked) {
                noBox.checked = false;
                naBox.checked = false;
                tempField.style.display = 'none';
            } else if (checkbox.id === 'eodResolvedNo' && checkbox.checked) {
                yesBox.checked = false;
                naBox.checked = false;
                tempField.style.display = 'block';
            } else if (checkbox.id === 'eodResolvedNA' && checkbox.checked) {
                yesBox.checked = false;
                noBox.checked = false;
                tempField.style.display = 'none';
            }
            
            updateProgress();
            autoSave();
        }

        function autoSave() {
            const data = {
                storeNumber: document.getElementById('storeNumber').value,
                date: document.getElementById('workDate').value,
                leadName: document.getElementById('leadName').value,
                notes: document.getElementById('notes').value,
                checkInManager: document.getElementById('checkInManager').value,
                checkOutManager: document.getElementById('checkOutManager').value,
                issueCommodities: document.getElementById('issueCommodities').value,
                issueDescription: document.getElementById('issueDescription').value,
                tempSolution: document.getElementById('tempSolution').value,
                eodHotlineYes: document.getElementById('eodHotlineYes').checked,
                eodHotlineNo: document.getElementById('eodHotlineNo').checked,
                eodResolvedYes: document.getElementById('eodResolvedYes').checked,
                eodResolvedNo: document.getElementById('eodResolvedNo').checked,
                eodResolvedNA: document.getElementById('eodResolvedNA').checked,
                eodProdYes: document.getElementById('eodProdYes').checked,
                eodProdNo: document.getElementById('eodProdNo').checked,
                eodSiYes: document.getElementById('eodSiYes').checked,
                eodSiNo: document.getElementById('eodSiNo').checked,
                eodEmailSheetYes: document.getElementById('eodEmailSheetYes').checked,
                eodEmailSheetNo: document.getElementById('eodEmailSheetNo').checked,
                eodProdSheetYes: document.getElementById('eodProdSheetYes').checked,
                eodProdSheetNo: document.getElementById('eodProdSheetNo').checked,
                eodBeforePhotoYes: document.getElementById('eodBeforePhotoYes').checked,
                eodBeforePhotoNo: document.getElementById('eodBeforePhotoNo').checked,
                eodAfterPhotoYes: document.getElementById('eodAfterPhotoYes').checked,
                eodAfterPhotoNo: document.getElementById('eodAfterPhotoNo').checked,
                signature: canvas.toDataURL('image/png'),
                checkedItems: Array.from(document.querySelectorAll('.checklist-item input[type="checkbox"]:not([name])')).map(cb => cb.checked)
            };
            
            localStorage.setItem('kompassChecklist', JSON.stringify(data));
        }

        function saveProgress(event) {
            if (event) event.preventDefault();
            autoSave(); // autoSave already does the saving
            // Re-using the custom modal for alerts
            showCustomAlert('Progress Saved', 'Your checklist progress has been saved to this device.');
        }

        function loadProgress() {
            const saved = localStorage.getItem('kompassChecklist');
            if (saved) {
                const data = JSON.parse(saved);
                
                if (data.storeNumber) document.getElementById('storeNumber').value = data.storeNumber;
                if (data.date) document.getElementById('workDate').value = data.date;
                if (data.leadName) document.getElementById('leadName').value = data.leadName;
                if (data.notes) document.getElementById('notes').value = data.notes;
                if (data.checkInManager) document.getElementById('checkInManager').value = data.checkInManager;
                if (data.checkOutManager) document.getElementById('checkOutManager').value = data.checkOutManager;
                if (data.eodHotlineYes) document.getElementById('eodHotlineYes').checked = true;
                if (data.eodHotlineNo) document.getElementById('eodHotlineNo').checked = true;
                if (data.issueCommodities) document.getElementById('issueCommodities').value = data.issueCommodities;
                if (data.issueDescription) document.getElementById('issueDescription').value = data.issueDescription;
                if (data.eodResolvedYes) document.getElementById('eodResolvedYes').checked = true;
                if (data.eodResolvedNo) document.getElementById('eodResolvedNo').checked = true;
                if (data.eodResolvedNA) document.getElementById('eodResolvedNA').checked = true;
                if (data.tempSolution) document.getElementById('tempSolution').value = data.tempSolution;
                if (data.eodProdYes) document.getElementById('eodProdYes').checked = true;
                if (data.eodProdNo) document.getElementById('eodProdNo').checked = true;
                if (data.eodSiYes) document.getElementById('eodSiYes').checked = true;
                if (data.eodSiNo) document.getElementById('eodSiNo').checked = true;
                if (data.eodEmailSheetYes) document.getElementById('eodEmailSheetYes').checked = true;
                if (data.eodEmailSheetNo) document.getElementById('eodEmailSheetNo').checked = true;
                if (data.eodProdSheetYes) document.getElementById('eodProdSheetYes').checked = true;
                if (data.eodProdSheetNo) document.getElementById('eodProdSheetNo').checked = true;
                if (data.eodBeforePhotoYes) document.getElementById('eodBeforePhotoYes').checked = true;
                if (data.eodBeforePhotoNo) document.getElementById('eodBeforePhotoNo').checked = true;
                if (data.eodAfterPhotoYes) document.getElementById('eodAfterPhotoYes').checked = true;
                if (data.eodAfterPhotoNo) document.getElementById('eodAfterPhotoNo').checked = true;

                // Show hotline details if yes is checked
                if (data.eodHotlineYes) {
                    document.getElementById('hotlineDetails').style.display = 'block';
                }
                
                // Show temp solution field if issue not resolved
                if (data.eodResolvedNo) {
                    document.getElementById('tempSolutionField').style.display = 'block';
                }

                // Restore signature
                if (data.signature) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.signature;
                }

                // Restore checkbox states
                if (data.checkedItems) {
                    document.querySelectorAll('.checklist-item input[type="checkbox"]:not([name])').forEach((checkbox, index) => {
                        if (data.checkedItems[index]) {
                            checkbox.checked = true;
                        }
                    });
                }
            }
        }

        function resetChecklist() {
            // Use custom confirm
            showCustomConfirm(
                'Reset Checklist',
                'Are you sure you want to reset the checklist? This will clear all saved progress.',
                () => {
                    // This code runs if the user clicks "Yes"
                    localStorage.removeItem('kompassChecklist');
                    
                    // Reset all fields
                    document.getElementById('storeNumber').value = '';
                    document.getElementById('workDate').valueAsDate = new Date();
                    document.getElementById('leadName').value = '';
                    document.getElementById('notes').value = '';
                    
                    // Reset EOD fields
                    document.getElementById('checkInManager').value = '';
                    document.getElementById('checkOutManager').value = '';
                    document.getElementById('eodHotlineYes').checked = false;
                    document.getElementById('eodHotlineNo').checked = false;
                    document.getElementById('issueCommodities').value = '';
                    document.getElementById('issueDescription').value = '';
                    document.getElementById('eodResolvedYes').checked = false;
                    document.getElementById('eodResolvedNo').checked = false;
                    document.getElementById('eodResolvedNA').checked = false;
                    document.getElementById('tempSolution').value = '';
                    document.getElementById('eodProdYes').checked = false;
                    document.getElementById('eodProdNo').checked = false;
                    document.getElementById('eodSiYes').checked = false;
                    document.getElementById('eodSiNo').checked = false;
                    document.getElementById('eodEmailSheetYes').checked = false;
                    document.getElementById('eodEmailSheetNo').checked = false;
                    document.getElementById('eodProdSheetYes').checked = false;
                    document.getElementById('eodProdSheetNo').checked = false;
                    document.getElementById('eodBeforePhotoYes').checked = false;
                    document.getElementById('eodBeforePhotoNo').checked = false;
                    document.getElementById('eodAfterPhotoYes').checked = false;
                    document.getElementById('eodAfterPhotoNo').checked = false;
                    
                    // Clear signature
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Uncheck all checkboxes
                    document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // Hide conditional fields
                    document.getElementById('hotlineDetails').style.display = 'none';
                    document.getElementById('tempSolutionField').style.display = 'none';

                    updateProgress(); // This will also trigger autoSave() with empty data
                }
            );
        }

        // Helper functions for PDF generation
        const pickYN = (v) => {
            if (typeof v === 'string') {
                const s = v.trim().toLowerCase();
                if (s.startsWith('y')) return 'Yes';
                if (s.startsWith('n')) return 'No';
            }
            return v ? 'Yes' : 'No';
        };

        const pickYNN = (v) => {
            if (typeof v === 'string') {
                const s = v.trim().toLowerCase();
                if (s === 'na' || s === 'n/a') return 'NA';
                if (s.startsWith('y')) return 'Yes';
                if (s.startsWith('n')) return 'No';
            }
            if (v === null || v === undefined) return 'NA';
            return v ? 'Yes' : 'No';
        };

        async function embedDataUrl(pdfDoc, dataUrl) {
            if (!dataUrl) return null;
            const res = await fetch(dataUrl);
            const bytes = await res.arrayBuffer();
            const isPng = dataUrl.startsWith('data:image/png');
            return isPng ? await pdfDoc.embedPng(bytes) : await pdfDoc.embedJpg(bytes);
        }

        function isoDate(d) {
            if (!d) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
            const dt = new Date(d);
            return Number.isNaN(dt) ? '' : dt.toISOString().slice(0,10);
        }

        async function signatureDataURL() {
            const pad = document.getElementById('signaturePad');
            if (pad && pad.toDataURL) {
                const dataUrl = pad.toDataURL('image/png');
                // Check if canvas is empty
                if (dataUrl === 'data:,') return '';
                return dataUrl;
            }
            return '';
        }

        async function collectPayload() {
            const v = sel => document.querySelector(sel)?.value ?? '';
            const r = name => (document.querySelector(`input[name="${name}"]:checked`)?.value ?? '');
            const yn = name => r(name).toLowerCase().startsWith('y');

            return {
                LeadName: v('#leadName'),
                DateISO: isoDate(v('#workDate')),
                StoreNumber: String(v('#storeNumber') || ''),
                CheckInManager: v('#checkInManager'),
                IssueCommodities: v('#issueCommodities'),
                TempSolution: v('#tempSolution'),
                CheckOutManager: v('#checkOutManager'),

                BeforePicPosted: yn('beforePicPosted'),
                CalledHotline: yn('calledHotline'),
                IssueResolved: r('issueResolved') || 'NA',
                SignedOutPROD: yn('signedOutPROD'),
                SignedOutSI: yn('signedOutSI'),
                SignoutSheetAttachedEmail: yn('signoutEmail'),
                SignoutSheetAttachedPROD: yn('signoutPROD'),
                AfterPicPosted: yn('afterPicPosted'),

                signatureDataURL: await signatureDataURL()
            };
        }

        async function fillPdf(data) {
            const src = await fetch(pdfUrl).then(r => {
                if (!r.ok) throw new Error('PDF not found. Please ensure the file "End Of Day Cover Sheet Form Editable Template.pdf" is in the same directory as this HTML file.');
                return r.arrayBuffer();
            });

            const pdfDoc = await PDFLib.PDFDocument.load(src);
            const form = pdfDoc.getForm();

            // Text fields
            form.getTextField('LeadName').setText(data.LeadName ?? '');
            form.getTextField('DateISO').setText(data.DateISO ?? '');
            form.getTextField('StoreNumber').setText(String(data.StoreNumber ?? ''));
            form.getTextField('CheckInManager').setText(data.CheckInManager ?? '');
            form.getTextField('IssueCommodities').setText(data.IssueCommodities ?? '');
            form.getTextField('WhatIsIssue').setText(data.WhatIsIssue ?? ''); 
            form.getTextField('TempSolution').setText(data.TempSolution ?? '');
            form.getTextField('CheckOutManager').setText(data.CheckOutManager ?? '');

            // Radio groups (Yes/No or Yes/No/NA)
            form.getRadioGroup('BeforePicPosted').select(pickYN(data.BeforePicPosted));
            form.getRadioGroup('CalledHotline').select(pickYN(data.CalledHotline));
            form.getRadioGroup('IssueResolved').select(pickYNN(data.IssueResolved));
            form.getRadioGroup('SignedOutPROD').select(pickYN(data.SignedOutPROD));
            form.getRadioGroup('SignedOutSI').select(pickYN(data.SignedOutSI));
            form.getRadioGroup('SignoutSheetAttachedEmail').select(pickYN(data.SignoutSheetAttachedEmail));
            form.getRadioGroup('SignoutSheetAttachedPROD').select(pickYN(data.SignoutSheetAttachedPROD));
            form.getRadioGroup('AfterPicPosted').select(pickYN(data.AfterPicPosted));

            // Signature image (Push Button named LeadSignatureImage)
            if (data.signatureDataURL) {
                const img = await embedDataUrl(pdfDoc, data.signatureDataURL);
                if (img) form.getButton('LeadSignatureImage').setImage(img);
            }

            form.flatten();

            const out = await pdfDoc.save();
            const blob = new Blob([out], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement('a'), {
                href: url,
                download: `EOD_FM${data.StoreNumber || 'store'}_${data.DateISO || 'date'}.pdf`
            });
            a.click();
            URL.revokeObjectURL(url);
        }

        async function generateEODCoverSheet() {
            try {
                const payload = await collectPayload();
                await fillPdf(payload);
                showCustomAlert('PDF Generated', 'EOD Cover Sheet PDF generated and downloaded successfully!<br><br>Please review the file and attach it to your EOD email along with sign-off sheets and photos.');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showCustomAlert('Error Generating PDF', error.message + '<br><br>Please ensure the file "End Of Day Cover Sheet Form Editable Template.pdf" is in the same directory as this HTML file.');
            }
        }

        // Auto-save form fields
        const formFields = [
            'storeNumber', 'workDate', 'leadName', 'notes',
            'checkInManager', 'checkOutManager', 'issueCommodities', 
            'issueDescription', 'tempSolution'
        ];
        
        formFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('change', autoSave);
                field.addEventListener('blur', autoSave);
            }
        });

        // Signature Pad functionality
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Set canvas size
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // Redraw signature if it exists
            const saved = localStorage.getItem('kompassChecklist');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.signature) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.signature;
                }
            }
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Drawing functions
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const currentX = touch.clientX - rect.left;
            const currentY = touch.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();

            lastX = currentX;
            lastY = currentY;
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                autoSave(); // Save signature when done drawing
            }
        }

        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch events
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);

        // Clear signature function
        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            autoSave();
        }
        
    </script>
    
    <script>
    async function collectPayload() {
    const v = sel => document.querySelector(sel)?.value ?? '';
    const r = name => (document.querySelector(`input[name="${name}"]:checked`)?.value ?? '');
    const yn = name => r(name).toLowerCase().startsWith('y');    // Yes/No → boolean
    const ynn = name => (r(name) || 'NA');                      // Yes/No/NA → string
    const isoDate = d => {
        if (!d) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
        const dt = new Date(d);
        return Number.isNaN(dt) ? '' : dt.toISOString().slice(0,10);
    };
    async function signatureDataURL() {
        const pad = document.getElementById('signaturePad');
        if (pad && pad.toDataURL) return pad.toDataURL('image/png');
        const file = document.getElementById('signatureFile')?.files?.[0];
        if (!file) return '';
        const b64 = await file.arrayBuffer().then(b => {
        let bin=''; new Uint8Array(b).forEach(x => bin += String.fromCharCode(x));
        return btoa(bin);
        });
        return `data:${file.type || 'image/png'};base64,${b64}`;
    }

    const called = yn('calledHotline'); // “Did you call the KOMPASS Hotline?”

    const payload = {
        // always-captured
        LeadName: v('#leadName'),
        DateISO: isoDate(v('#workDate')),
        StoreNumber: String(v('#storeNumber') || ''),
        CheckInManager: v('#checkInManager'),
        CheckOutManager: v('#checkOutManager'),
        BeforePicPosted: yn('beforePicPosted'),
        CalledHotline: called,
        SignedOutPROD: yn('signedOutPROD'),
        SignedOutSI: yn('signedOutSI'),
        SignoutSheetAttachedEmail: yn('signoutEmail'),
        SignoutSheetAttachedPROD: yn('signoutPROD'),
        AfterPicPosted: yn('afterPicPosted'),
        signatureDataURL: await signatureDataURL()
    };

    if (called) {
        // user selected Yes → take their entries
        payload.IssueCommodities = v('#issueCommodities');
        payload.WhatIsIssue = v('#issueDescription'); // Corrected this line
        payload.IssueResolved = ynn('issueResolved'); // 'Yes' | 'No' | 'NA'
        payload.TempSolution = v('#tempSolution');
    } else {
        // user selected No → cascade N/A everywhere
        payload.IssueCommodities = 'N/A';
        payload.WhatIsIssue = 'N/A';
        payload.IssueResolved = 'NA';
        payload.TempSolution = 'N/A';
    }

    return payload;
    }
</script>

    <button id="selectAll">Select All & Fill "Test"</button>

<script>
    (function () {
    const setVal = (sel, val) => {
        const el = document.querySelector(sel);
        if (!el) return;
        el.value = val;
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
    };
    const pick = (name, val) => {
        const el = document.querySelector(`input[name="${name}"][value="${val}"]`);
        if (!el) return;
        el.checked = true;
        el.dispatchEvent(new Event('change', { bubbles: true }));
    };

    document.getElementById('selectAll').addEventListener('click', () => {
        // Text fields → "Test" (date = today)
        setVal('#leadName', 'Test');
        setVal('#workDate', new Date().toISOString().slice(0,10));
        setVal('#storeNumber', 'Test');
        setVal('#checkInManager', 'Test');
        setVal('#issueCommodities', 'Test');
        setVal('#tempSolution', 'Test');
        setVal('#checkOutManager', 'Test');
        setVal('#issueDescription', 'Test issue'); // Added issueDescription

        // Radios: force "Yes"
        ['beforePicPosted','calledHotline','signedOutPROD','signedOutSI',
        'signoutEmail','signoutPROD','afterPicPosted'].forEach(n => pick(n, 'Yes'));
        pick('issueResolved','Yes'); // 3-state group

        // Any loose checkboxes on the page
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
        cb.dispatchEvent(new Event('change', { bubbles: true }));
        });
    });
    })();
</script>

    <button id="listFields">List PDF Fields</button>
<script>
    document.getElementById('listFields').addEventListener('click', async () => {
    try {
        const r = await fetch(pdfUrl);
        if (!r.ok) throw new Error('PDF not found at pdfUrl: ' + pdfUrl);
        const bytes = await r.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(bytes);
        const form = pdfDoc.getForm();
        const names = form.getFields().map(f => f.getName());
        showCustomAlert('PDF Form Fields Found', names.join('<br>'));
    } catch (e) {
        showCustomAlert('Load/List Error', e.message);
    }
    });
</script>
    <script>
(() => {
    // Local helpers used by the overrides
    const pickYN = (v) => {
    if (typeof v === 'string') {
        const s = v.trim().toLowerCase();
        if (s.startsWith('y')) return 'Yes';
        if (s.startsWith('n')) return 'No';
    }
    return v ? 'Yes' : 'No';
    };
    const pickYNN = (v) => {
    if (typeof v === 'string') {
        const s = v.trim().toLowerCase();
        if (s === 'na' || s === 'n/a') return 'NA';
        if (s.startsWith('y')) return 'Yes';
        if (s.startsWith('n')) return 'No';
    }
    if (v === null || v === undefined) return 'NA';
    return v ? 'Yes' : 'No';
    };
    async function embedDataUrl(pdfDoc, dataUrl) {
    if (!dataUrl) return null;
    const res = await fetch(dataUrl);
    const bytes = await res.arrayBuffer();
    const isPng = dataUrl.startsWith('data:image/png');
    return isPng ? await pdfDoc.embedPng(bytes) : await pdfDoc.embedJpg(bytes);
    }
    function isoDate(d) {
    if (!d) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const dt = new Date(d);
    return Number.isNaN(dt) ? '' : dt.toISOString().slice(0,10);
    }
    async function getSignatureDataURL() {
    const pad = document.getElementById('signaturePad');
    if (pad && pad.toDataURL) {
        const dataUrl = pad.toDataURL('image/png');
        if (dataUrl === 'data:,') return '';
        return dataUrl;
    }
    return '';
    }

    // ---------- NEW HELPER FUNCTION (Extracted from fillPdf) ----------
    async function createFilledPdfBytes(data) {
        const src = await fetch(pdfUrl).then(r => {
            if (!r.ok) throw new Error('PDF not found. Please ensure the file "End Of Day Cover Sheet Form Editable Template.pdf" is in the same directory as this HTML file.');
            return r.arrayBuffer();
        });

        const pdfDoc = await PDFLib.PDFDocument.load(src);
        const form = pdfDoc.getForm();

        // Text fields (includes WhatIsIssue)
        form.getTextField('LeadName').setText(data.LeadName ?? '');
        form.getTextField('DateISO').setText(data.DateISO ?? '');
        form.getTextField('StoreNumber').setText(String(data.StoreNumber ?? ''));
        form.getTextField('CheckInManager').setText(data.CheckInManager ?? '');
        form.getTextField('IssueCommodities').setText(data.IssueCommodities ?? '');
        form.getTextField('WhatIsIssue').setText(data.WhatIsIssue ?? '');
        form.getTextField('TempSolution').setText(data.TempSolution ?? '');
        form.getTextField('CheckOutManager').setText(data.CheckOutManager ?? '');

        // Radio groups
        form.getRadioGroup('BeforePicPosted').select(pickYN(data.BeforePicPosted));
        form.getRadioGroup('CalledHotline').select(pickYN(data.CalledHotline));
        form.getRadioGroup('IssueResolved').select(pickYNN(data.IssueResolved));
        form.getRadioGroup('SignedOutPROD').select(pickYN(data.SignedOutPROD));
        form.getRadioGroup('SignedOutSI').select(pickYN(data.SignedOutSI));
        form.getRadioGroup('SignoutSheetAttachedEmail').select(pickYN(data.SignoutSheetAttachedEmail));
        form.getRadioGroup('SignoutSheetAttachedPROD').select(pickYN(data.SignoutSheetAttachedPROD));
        form.getRadioGroup('AfterPicPosted').select(pickYN(data.AfterPicPosted));

        // Signature image (Push Button named LeadSignatureImage)
        if (data.signatureDataURL) {
            const img = await embedDataUrl(pdfDoc, data.signatureDataURL);
            if (img) form.getButton('LeadSignatureImage').setImage(img);
        }

        form.flatten();
        return await pdfDoc.save();
    }


    // ---------- OVERRIDES ----------
    // Collect payload (adds WhatIsIssue + hotline "No" cascade to N/A)
    window.collectPayload = async function collectPayload() {
    const v = sel => document.querySelector(sel)?.value ?? '';
    const r = name => (document.querySelector(`input[name="${name}"]:checked`)?.value ?? '');
    const yn = name => r(name).toLowerCase().startsWith('y');

    const payload = {
        LeadName: v('#leadName'),
        DateISO: isoDate(v('#workDate')),
        StoreNumber: String(v('#storeNumber') || ''),
        CheckInManager: v('#checkInManager'),
        IssueCommodities: v('#issueCommodities'),
        WhatIsIssue: v('#issueDescription'), // Corrected from issueDescription
        TempSolution: v('#tempSolution'),
        CheckOutManager: v('#checkOutManager'),

        BeforePicPosted: yn('beforePicPosted'),
        CalledHotline: yn('calledHotline'),
        IssueResolved: r('issueResolved') || 'NA',
        SignedOutPROD: yn('signedOutPROD'),
        SignedOutSI: yn('signedOutSI'),
        SignoutSheetAttachedEmail: yn('signoutEmail'),
        SignoutSheetAttachedPROD: yn('signoutPROD'),
        AfterPicPosted: yn('afterPicPosted'),

        signatureDataURL: await getSignatureDataURL()
    };

    // If hotline was NOT called, normalize related fields to N/A
    if (!payload.CalledHotline) {
        payload.IssueCommodities = 'N/A';
        payload.WhatIsIssue = 'N/A';
        payload.TempSolution = 'N/A';
        payload.IssueResolved = 'NA';
    }

    return payload;
    };

    // Fill the PDF (adds WhatIsIssue and new filename)
    // MODIFIED to use the new helper function
    window.fillPdf = async function fillPdf(data) {
        const out = await createFilledPdfBytes(data); // Use helper
        const blob = new Blob([out], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), {
            href: url,
            download: `EOD Cover Sheet FM${data.StoreNumber || 'store'} ${data.DateISO || 'date'}.pdf`
        });
        a.click();
        URL.revokeObjectURL(url);
    };

    // Rebind generator to use the overrides (name unchanged)
    window.generateEODCoverSheet = async function generateEODCoverSheet() {
    try {
        const payload = await window.collectPayload();
        await window.fillPdf(payload);
        showCustomAlert('PDF Generated', 'EOD Cover Sheet PDF generated and downloaded successfully!<br><br>Please review the file and attach it to your EOD email along with sign-off sheets and photos.');
    } catch (error) {
        console.error('Error generating PDF:', error);
        showCustomAlert('Error Generating PDF', error.message + '<br><br>Please ensure the file "End Of Day Cover Sheet Form Editable Template.pdf" is in the same directory as this HTML file.');
    }
    };

    // ---------- NEW IMAGE GENERATION FUNCTION ----------
    window.generateEODImage = async function generateEODImage() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.add('show');
        
        try {
            // 1. Get data and create the filled PDF bytes
            const payload = await window.collectPayload();
            const pdfBytes = await createFilledPdfBytes(payload);

            // 2. Load the PDF bytes into pdf.js
            const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
            const pdfDoc = await loadingTask.promise;
            const page = await pdfDoc.getPage(1); // Get the first page

            // 3. Create a canvas to render the PDF
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // 4. Set canvas size with high resolution (e.g., 2x scale)
            const scale = 2.0;
            const viewport = page.getViewport({ scale: scale });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            // 5. Render the PDF page to the canvas
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;

            // 6. Convert canvas to JPG and trigger download
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9); // 0.9 = 90% quality
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `EOD Cover Sheet FM${payload.StoreNumber || 'store'} ${payload.DateISO || 'date'}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            showCustomAlert('Image Generated', 'EOD Cover Sheet JPG generated and downloaded successfully!');

        } catch (error) {
            console.error('Error generating JPG:', error);
            showCustomAlert('Error Generating Image', error.message);
        } finally {
            // 7. Hide loading overlay
            overlay.classList.remove('show');
        }
    };

})();
</script>

<style>
    .kompass-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.6);
    z-index: 9999;
    padding: 20px;
    }
    .kompass-modal.show { display: flex; }
    .kompass-card {
    background: #fff;
    max-width: 760px;
    width: min(92vw,760px);
    max-height: 88vh;
    overflow-y: auto;
    border-radius: 14px;
    padding: 22px 26px 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    font-family: system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    .kompass-card h2 { margin: 0 0 .5rem 0; font-size: 1.35rem; color: #333; }
    .kompass-card h3 { margin: 1rem 0 .25rem 0; font-size: 1.05rem; color: #111; }
    .kompass-card p, .kompass-card li { color: #444; line-height: 1.6; }
    .kompass-card p { margin-bottom: 0.75rem; }
    .kompass-card ul { margin-left: 20px; margin-bottom: 1rem; }
    .kompass-card li { margin-bottom: 0.25rem; }

    .kompass-actions { display: flex; gap: .75rem; justify-content: flex-end; margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1rem; }
    .kompass-actions .btn { border: 0; border-radius: 8px; padding: .6rem 1.1rem; cursor: pointer; font-weight: 600; font-size: 0.95rem; }
    .kompass-actions .btn-primary { background: #667eea; color: #fff; }
    .kompass-actions .btn-primary:hover { background: #764ba2; }
    .kompass-actions .btn-secondary { background: #e0e0e0; color: #333; }
    .kompass-actions .btn-secondary:hover { background: #d0d0d0; }
    .kompass-actions .btn[disabled] { opacity: .6; cursor: not-allowed; }
    
    /* Custom Alert/Confirm Styles */
    #kompassAlert .kompass-card { max-width: 480px; }
    #kompassAlert p { font-size: 1.1rem; line-height: 1.6; color: #333; }
    #kompassConfirm .kompass-actions { justify-content: space-between; }
    #kompassConfirm #kcf-no { background: #e0e0e0; color: #333; }
    #kompassConfirm #kcf-yes { background: #D9534F; color: #fff; }
</style>

<!-- DISCLAIMER (first-visit only) -->
<div id="kompassDisclaimer" class="kompass-modal" aria-hidden="true" role="dialog" aria-labelledby="kdc-title">
    <div class="kompass-card" role="document">
    <h2 id="kdc-title">⚠️ Important: Please Read Before Using This Checklist</h2>
    <p><strong>Welcome to the KOMPASS Lead Daily Checklist!</strong></p>
    <p>Before you begin, please understand and acknowledge the following:</p>

    <h3>This is a Living Document</h3>
    <p>Much like the dynamic nature of your role as a KOMPASS Lead, this checklist is fluid and ever-evolving. Don't expect it to stay the same—it will be updated as processes improve and new insights are gained.</p>

    <h3>It's a Guide, Not a Rulebook</h3>
    <p>I've compiled what I believe are the primary steps and processes to help you navigate your day successfully. However, I know there are pieces missing, and I'm not perfect—nor do I expect you to be. Use this as a tool and a guide, not as an inflexible set of rules.</p>

    <h3>Your Feedback Matters</h3>
    <p>If you notice something missing, unclear, or out of order, please share that feedback. Your real-world experience is invaluable in making this resource better for everyone.</p>

    <h3>Every Situation is Different</h3>
    <p>Every store, every day, and every lead has a slightly different process. Don't get stuck on specific wording or the exact order of items. If a step doesn't fit your situation or doesn't apply, use your logic, common sense, and best practices to either:</p>
    <ul>
        <li>Ask questions of your supervisor or support team</li>
        <li>Arrive at a solution independently based on your training and experience</li>
    </ul>

    <h3>Limitation of Liability</h3>
    <p>By using this checklist, you acknowledge and agree that:</p>
    <ul>
        <li>This is an aid created to support your success</li>
        <li>You will not hold me or anyone else responsible for the information contained within</li>
        <li>You understand this is meant as a guide to help support official policy</li>
        <li>You will use your professional judgment and company guidelines when making decisions</li>
    </ul>

    <p>If you can be understanding of these points and use the checklist as the helpful tool it's meant to be, it will serve you well in navigating your responsibilities and achieving success in your role.</p>

    <label style="display:flex;gap:.55rem;align-items:flex-start;margin-top:.75rem">
        <input id="kdc-agree" type="checkbox" />
        <span>I have read, understand, and agree to the above disclaimer</span>
    </label>

    <div class="kompass-actions">
        <button id="kdc-cancel" class="btn btn-secondary">Cancel</button>
        <button id="kdc-accept" class="btn btn-primary" disabled>Agree & Continue</button>
    </div>
    </div>
</div>

<!-- Custom Alert Modal -->
<div id="kompassAlert" class="kompass-modal" aria-hidden="true" role="dialog" aria-labelledby="ka-title">
    <div class="kompass-card" role="document">
        <h2 id="ka-title">Alert</h2>
        <p id="ka-message">This is an alert message.</p>
        <div class="kompass-actions">
            <button id="ka-ok" class="btn btn-primary">OK</button>
        </div>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="kompassConfirm" class="kompass-modal" aria-hidden="true" role="dialog" aria-labelledby="kcf-title">
    <div class="kompass-card" role="document">
        <h2 id="kcf-title">Confirm</h2>
        <p id="kcf-message">Are you sure?</p>
        <div class="kompass-actions">
            <button id="kcf-no" class="btn btn-secondary">Cancel</button>
            <button id="kcf-yes" class="btn btn-primary">Yes</button>
        </div>
    </div>
</div>

<script>
(function(){
    // --- Disclaimer Modal ---
    const KEY = 'kompassDisclaimerAccepted.v1';
    const modal = document.getElementById('kompassDisclaimer');
    const agree = document.getElementById('kdc-agree');
    const accept = document.getElementById('kdc-accept');
    const cancel = document.getElementById('kdc-cancel');

    function openModal(){
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    accept.disabled = !agree.checked;
    agree.focus();
    }

    function closeModal(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
    try {
        if (localStorage.getItem(KEY) !== 'true') {
        openModal();
        }
    } catch (e) {
        openModal();
    }
    });

    agree.addEventListener('change', () => { accept.disabled = !agree.checked; });
    
    accept.addEventListener('click', () => {
    try { localStorage.setItem(KEY,'true'); } catch (e) { /* ignore */ }
    closeModal();
    });
    
    cancel.addEventListener('click', () => { closeModal(); });

    // --- Custom Alert & Confirm ---
    const alertModal = document.getElementById('kompassAlert');
    const alertTitle = document.getElementById('ka-title');
    const alertMessage = document.getElementById('ka-message');
    const alertOk = document.getElementById('ka-ok');

    const confirmModal = document.getElementById('kompassConfirm');
    const confirmTitle = document.getElementById('kcf-title');
    const confirmMessage = document.getElementById('kcf-message');
    const confirmYes = document.getElementById('kcf-yes');
    const confirmNo = document.getElementById('kcf-no');

    let confirmCallback = null;

    window.showCustomAlert = (title, message) => {
        alertTitle.innerHTML = title;
        alertMessage.innerHTML = message;
        alertModal.classList.add('show');
        alertModal.setAttribute('aria-hidden', 'false');
        alertOk.focus();
    };

    alertOk.addEventListener('click', () => {
        alertModal.classList.remove('show');
        alertModal.setAttribute('aria-hidden', 'true');
    });

    window.showCustomConfirm = (title, message, onConfirm) => {
        confirmTitle.innerHTML = title;
        confirmMessage.innerHTML = message;
        confirmModal.classList.add('show');
        confirmModal.setAttribute('aria-hidden', 'false');
        confirmCallback = onConfirm;
        confirmYes.focus();
    };

    confirmYes.addEventListener('click', () => {
        confirmModal.classList.remove('show');
        confirmModal.setAttribute('aria-hidden', 'true');
        if (confirmCallback) {
            confirmCallback();
        }
        confirmCallback = null;
    });

    confirmNo.addEventListener('click', () => {
        confirmModal.classList.remove('show');
        confirmModal.setAttribute('aria-hidden', 'true');
        confirmCallback = null;
    });

    // Override default alert and confirm
    window.alert = (message) => {
        console.warn("window.alert() called. Using custom modal.");
        showCustomAlert('Alert', message);
    };

    window.confirm = (message) => {
        console.warn("window.confirm() called. Using custom modal. This will block execution, which may not be intended.");
        // Note: This custom implementation doesn't block execution like native confirm()
        // The resetChecklist function is now implemented with a callback, so it's fine.
        showCustomConfirm('Confirm', message, () => {
             // This is a basic override.
             // For the resetChecklist function, it's already refactored to use the callback.
             // For other potential window.confirm() calls, this will default to "true"
             // which is a limitation of not being able to block the thread.
        });
        // Since we can't block, native 'confirm' behavior can't be perfectly replicated.
        // We return false by default and rely on callbacks.
        return false;
    };

})();
</script>

</body>
</html>
