<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Kompass Lead Daily Checklist</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    html {
        scroll-behavior: smooth;
    }
    
</style>


<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        /* UPDATED: Dark theme background */
        background: #1f2937; /* gray-800 */
        min-height: 100vh;
        padding: 20px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

        /* --- NEW LOADING OVERLAY STYLE --- */
        .loading-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            /* UPDATED: Dark theme loader */
            background: rgba(17, 24, 39, 0.8); /* gray-900 with opacity */
            z-index: 10000;
            font-size: 1.5em;
            font-weight: bold;
            color: #88c4ed; /* RO Light Blue */
            backdrop-filter: blur(5px);
        }
        .loading-overlay.show {
            display: flex;
        }
        /* --- END NEW STYLE --- */

        .container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            /* UPDATED: Dark theme container */
            background: #374151; /* gray-700 */
            color: #f9fafb; /* gray-50 */
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            /* UPDATED: Add padding-top to account for sticky header */
            padding-top: 300px; /* Adjust this value based on header's final height */
        }

        @media (max-width: 1024px) {
            .container {
                max-width: 95%;
            }
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                border-radius: 10px;
            }
        }

        .header {
            /* UPDATED: Darker header background */
            background: #000000; /* This is black */
            color: white;
            padding: 20px 30px 15px 30px; /* Adjusted padding */
            text-align: center;
            /* --- NEW: Sticky Header --- */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            /* Find the matching container width */
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            border-bottom: 2px solid #0d4f8b;
            border-radius: 0 0 15px 15px; /* Match container */
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        /* Adjust container padding-top when header is fixed */
        body {
            padding-top: 320px; /* Give space for the fixed header */
        }
        /* Remove body padding for a full-width header effect */
        @media (min-width: 1040px) { /* 1000px container + 20px padding * 2 */
             body {
                padding: 20px;
                padding-top: 320px; 
             }
             .header {
                border-radius: 0 0 15px 15px;
             }
        }
         @media (max-width: 1040px) {
             body {
                 padding: 0; /* No padding on mobile */
                 padding-top: 300px; /* Adjust based on mobile header height */
             }
             .container {
                 padding-top: 0; /* Container is no longer padded */
                 border-radius: 0;
             }
             .header {
                 position: fixed;
                 top: 0;
                 left: 0;
                 right: 0;
                 width: 100%;
                 max-width: 100%;
                 border-radius: 0;
                 padding: 15px 15px 10px 15px;
             }
         }


        /* --- NEW: Logo Style --- */
        .header-logo {
            max-width: 500px; /* Adjusted size */
            width: 80%;
            height: 70%;
            margin-bottom: 5px;
        }
        /* --- END NEW STYLE --- */

        .header h1 {
            font-size: 1.8em; /* Adjusted size */
            margin-bottom: 15px;
        }

        .header-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }

        .input-group label {
            /* UPDATED: Increased font size */
            font-size: 1em;
            font-weight: 600;
            color: white;
        }

        .header-info input {
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            width: 100%;
        }
        
        /* UPDATED: Increased height and font size for header inputs */
        .input-group input {
            padding: 18px 10px; /* Slightly adjusted height */
            font-size: 1.3em;   /* Increased font size */
            border: none;
            border-radius: 5px;
            width: 100%;
            /* Dark mode inputs */
            background: #4b5563; /* gray-600 */
            color: #f9fafb;
        }
        .input-group input[type="date"] {
            line-height: 1.5; /* Adjust date input line height */
        }


        .progress-bar-container {
            background: rgba(255, 255, 255, 0.2);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 15px; /* Adjusted margin */
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            min-width: 0;
            white-space: nowrap;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            border: 2px solid #4b5563; /* gray-600 */
            border-radius: 10px;
            overflow: hidden;
        }

        .section-header {
            /* UPDATED: Use Retail Odyssey logo colors */
            background: #0d4f8b; /* RO Dark Blue */
            color: #88c4ed; /* RO Light Blue */
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
            transition: opacity 0.2s ease;
        }

        .section-header:hover {
            opacity: 0.9;
        }

        .section-header:active {
            opacity: 0.8;
        }

        .section-content {
            padding: 20px;
            /* UPDATED: Dark theme content bg */
            background: #4b5563; /* gray-600 */
        }
        
        /* --- This style block has been removed as it's no longer needed --- */

        .checklist-item {
            /* UPDATED: Dark theme item bg */
            background: #374151; /* gray-700 */
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            /* UPDATED: Use RO Dark Blue for border */
            border-left: 4px solid #0d4f8b;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .checklist-item.completed {
            border-left-color: #56ab2f;
            opacity: 0.7;
        }

        .item-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .checkbox-wrapper {
            flex-shrink: 0;
            padding-top: 2px;
        }

        input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            /* UPDATED: Use RO Light Blue for accent */
            accent-color: #88c4ed;
            flex-shrink: 0;
        }

        .item-content {
            flex-grow: 1;
        }

        .item-title {
            font-weight: bold;
            /* UPDATED: Light text */
            color: #f9fafb; /* gray-50 */
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        /* --- NEW: EOD Cover Sheet Style --- */
        .eod-highlight {
            color: #f59e0b; /* amber-500 (gold) */
            font-weight: bold;
            /* Red border effect */
            text-shadow: 
                -1px -1px 0 #dc2626,  
                 1px -1px 0 #dc2626,
                -1px  1px 0 #dc2626,
                 1px  1px 0 #dc2626;
        }
        /* --- END NEW STYLE --- */


        .item-description {
            /* UPDATED: Light text */
            color: #d1d5db; /* gray-300 */
            line-height: 1.6;
        }

        .item-description ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .item-description li {
            margin-bottom: 5px;
        }

        .eod-field {
            margin: 10px 0;
            padding: 10px;
            /* UPDATED: Dark theme EOD field */
            background: #374151; /* gray-700 */
            border-radius: 5px;
            /* UPDATED: Use RO Light Blue for border */
            border-left: 3px solid #88c4ed;
        }

        .eod-field label {
            display: block;
            font-weight: 600;
            /* UPDATED: Use RO Light Blue for text */
            color: #88c4ed;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .eod-field input[type="text"],
        .eod-field textarea {
            width: 100%;
            padding: 8px;
            /* UPDATED: Dark theme inputs */
            border: 1px solid #4b5563; /* gray-600 */
            background: #4b5563; /* gray-600 */
            color: #f9fafb;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.95em;
        }

        .eod-field textarea {
            min-height: 60px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 8px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .checkbox-option label {
            font-weight: 600;
            /* UPDATED: Light text */
            color: #f9fafb; /* gray-50 */
            cursor: pointer;
        }

        .signature-section {
            margin: 30px 0;
            padding: 20px;
            /* UPDATED: Dark theme bg */
            background: #4b5563; /* gray-600 */
            border-radius: 10px;
            /* UPDATED: Use RO Dark Blue for border */
            border: 2px solid #0d4f8b;
        }

        .signature-label {
            font-weight: 600;
            font-size: 1em;
            display: block;
            margin-bottom: 10px;
            /* UPDATED: Use RO Light Blue for text */
            color: #88c4ed;
        }

        .signature-canvas {
            border: 2px solid #0d4f8b;
            border-radius: 8px;
            /* UPDATED: Keep canvas white so signature is visible */
            background: white;
            cursor: crosshair;
            display: block;
            width: 100%;
            /* UPDATED: 25% taller (150 * 1.25) */
            height: 188px;
            touch-action: none;
        }

        .btn-clear-sig {
            margin-top: 10px;
            padding: 10px 20px;
            /* UPDATED: Use RO Dark Blue */
            background: #0d4f8b;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
            color: white;
            font-weight: 600;
        }

        .btn-clear-sig:hover {
            /* UPDATED: Use RO Light Blue */
            background: #88c4ed;
            color: #111827;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            /* UPDATED: Use RO Dark Blue */
            background: #0d4f8b;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            /* UPDATED: Use RO Light Blue for shadow */
            box-shadow: 0 5px 15px rgba(136, 196, 237, 0.4);
            background: #1e66ab; /* Darken RO blue */
        }

        .btn-secondary {
            /* UPDATED: Dark theme secondary */
            background: #4b5563; /* gray-600 */
            color: #f9fafb; /* gray-50 */
        }

        .btn-secondary:hover {
            background: #5a6573;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        /* --- NEW CUSTOM ALERT MODAL --- */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            backdrop-filter: blur(4px);
        }
        .custom-modal-overlay.show {
            display: flex;
        }
        .custom-modal-dialog {
            /* UPDATED: Dark theme modal */
            background: #374151; /* gray-700 */
            color: #f9fafb;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .custom-modal-dialog h2 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.25em;
            /* UPDATED: Light text */
            color: #f9fafb;
        }
        .custom-modal-dialog p {
            margin-bottom: 24px;
            /* UPDATED: Light text */
            color: #d1d5db; /* gray-300 */
            line-height: 1.6;
        }
        .custom-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        /* --- END CUSTOM ALERT MODAL --- */

        .notes-section {
            margin-top: 30px;
            padding: 20px;
            /* UPDATED: Dark theme notes */
            background: #4a2c0d;
            border-radius: 10px;
            border: 2px solid #f59e0b; /* amber-500 */
        }

        .notes-section h3 {
            /* UPDATED: Light text */
            color: #fcd34d; /* amber-300 */
            margin-bottom: 10px;
        }

        .notes-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            /* UPDATED: Dark theme textarea */
            border: 1px solid #f59e0b;
            background: #5a3c1d;
            color: #f9fafb;
            border-radius: 5px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
        }

        .email-list {
            /* UPDATED: Dark theme email list (use RO colors) */
            background: #0d4f8b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .email-list h4 {
            /* UPDATED: Light text */
            color: #f9fafb;
            margin-bottom: 8px;
        }

        .email-list ul {
            list-style: none;
            margin-left: 0;
        }

        .email-list li {
            /* UPDATED: Use RO Light Blue */
            color: #88c4ed;
            padding: 3px 0;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
        }

        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }

            .header {
                padding: 15px 12px 10px 12px;
            }

            .header h1 {
                font-size: 1.3em;
                margin-bottom: 12px;
            }
            
            /* UPDATED: Adjust header inputs for mobile */
            .input-group input {
                padding: 15px 10px;
                font-size: 1.2em;
            }

            .header-row {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 12px;
            }

            .input-group label {
                font-size: 0.8em;
                margin-bottom: 3px;
            }

            /*
            .header-info input,
            .input-group input {
                padding: 10px;
                font-size: 1em;
                width: 100%;
            }
            */

            .progress-bar-container {
                margin-top: 15px;
                height: 25px;
            }

            .content {
                padding: 15px 12px;
            }

            .section-header {
                padding: 12px 15px;
                font-size: 1.1em;
            }

            .section-content {
                padding: 12px;
            }

            .checklist-item {
                padding: 12px;
                margin-bottom: 12px;
            }

            .item-header {
                gap: 12px;
            }

            .item-title {
                font-size: 1em;
            }

            .item-description {
                font-size: 0.9em;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                padding: 14px 20px;
            }

            .checkbox-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .email-list {
                padding: 12px;
            }

            .notes-section {
                padding: 15px;
            }

            .signature-section {
                padding: 15px;
            }
        }
        
        /* Recalculate sticky header for smaller mobile */
        @media (max-width: 380px) {
            body {
                padding-top: 280px; /* Adjust based on smaller mobile header height */
            }   
            .input-group input {
                font-size: 1.1em;
            }
        }


        @media print {
            body {
                background: white;
                padding: 0;
                /* UPDATED: Ensure text is black for printing */
                color: #000;
            }
            
            /* --- Hide sticky header for printing --- */
            .header {
                position: static;
                height: auto;
                box-shadow: none;
                border-radius: 0;
                border-bottom: 3px solid #667eea;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
                /* UPDATED: Ensure text is black for printing */
                color: #000;
                padding-top: 0; /* Remove padding for printing */
            }
            
            body {
                padding-top: 0; /* Remove padding for printing */
            }

            .header {
                background: white;
                color: black;
                border-bottom: 3px solid #667eea;
            }
            
            /* NEW: Hide logo when printing */
            .header-logo {
                display: none;
            }

            .section-header {
                background: white;
                color: #667eea;
                border: 2px solid #667eea;
                page-break-after: avoid;
            }
            
            /* --- Hide bottom collapse button when printing --- */
            .section-footer-collapse {
                display: none;
            }

            .section-content {
                page-break-inside: avoid;
                /* UPDATED: Force white bg for printing */
                background: #fff;
            }

            .checklist-item {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #e0e0e0;
                /* UPDATED: Force white bg for printing */
                background: #fff;
            }
            
            /* UPDATED: Force text to black for printing */
            .item-title, .item-description, .checkbox-option label {
                color: #333;
            }
            /* Revert EOD highlight for printing */
            .eod-highlight {
                color: #000;
                font-weight: bold;
                text-shadow: none;
            }
            
            .eod-field {
                background: #f0f7ff;
            }
            .eod-field label {
                color: #1976d2;
            }
            .input-group input {
                background: #eee;
                color: #000;
            }

            .button-group,
            .signature-section {
                display: none;
            }

            .progress-bar-container {
                border: 2px solid #667eea;
            }

            .notes-section {
                page-break-inside: avoid;
                background: #fff3cd;
                border-color: #ffc107;
            }
            .notes-section h3 {
                color: #856404;
            }
            .notes-section textarea {
                background: #fff;
                color: #000;
            }
            
            @page {
                size: letter;
                margin: 0.35in 0.4in;
            }
        }

        /* Ensure inputs are touch-friendly on mobile */
        @media (hover: none) and (pointer: coarse) {
            input, textarea, button {
                font-size: 16px !important;
            }

            input[type="checkbox"] {
                width: 24px;
                height: 24px;
                min-width: 24px;
            }
        }
    /* --- NEW DISCLAIMER MODAL STYLES --- */
        .disclaimer-content {
            max-height: 40vh; /* Set max height for content */
            overflow-y: auto; /* Add scrollbar if content overflows */
            border-top: 1px solid #4b5563; /* gray-600 */
            border-bottom: 1px solid #4b5563; /* gray-600 */
            padding: 16px 5px;
            margin-bottom: 16px;
            color: #d1d5db; /* gray-300 */
        }
        .disclaimer-content h3 {
            color: #f9fafb; /* gray-50 */
            margin-top: 12px;
            margin-bottom: 8px;
        }
        .disclaimer-content p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .disclaimer-content ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .disclaimer-agree {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .disclaimer-agree label {
            font-size: 0.9em;
            color: #f9fafb; /* gray-50 */
            cursor: pointer;
        }
        .disclaimer-agree input[type="checkbox"] {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        #disclaimerConfirm:disabled {
            background: #4b5563; /* gray-600 */
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* --- NEW TOGGLE SWITCH STYLES --- */
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; /* Make it take full width in the column layout */
            margin-bottom: 15px;
            padding: 10px;
            background: #4b5563; /* gray-600 */
            border-radius: 8px;
        }
        .toggle-switch-label { /* The text label */
            color: #f9fafb; /* gray-50 */
            font-weight: 600;
            margin-left: 12px;
            cursor: pointer;
        }
        .toggle-switch-wrapper { /* The switch itself */
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            cursor: pointer;
        }
        .toggle-switch-wrapper input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider { /* The track */
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151; /* gray-700 */
            border-radius: 28px;
            transition: .3s;
        }
        .toggle-slider:before { /* The circle */
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .3s;
        }
        input:checked + .toggle-slider {
            background-color: #0d4f8b; /* RO Dark Blue */
        }
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- NEW: Added Retail Odyssey Logo (click to open quick EOD view) -->
            <img id="headerLogo" src="rologo.png" alt="Retail Odyssey Logo" class="header-logo" onerror="this.style.display='none'" style="cursor: pointer;" title="Click for EOD Quick View">
            <h1>KOMPASS LEAD DAILY CHECKLIST</h1>
            
            <!-- Single Row: Store, Date, Lead Name -->
            <div class="header-row">
                <div class="input-group">
                    <label>Store #:</label>
                    <!-- ADDED onchange handler -->
                    <input type="text" id="storeNumber" placeholder="Enter store number" onchange="autoSave()">
                </div>
                <div class="input-group">
                    <label>Date:</label>
                    <!-- ADDED onchange handler -->
                    <input type="date" id="workDate" onchange="autoSave()">
                </div>
                <div class="input-group">
                    <label>Lead Name:</label>
                    <!-- ADDED onchange handler -->
                    <input type="text" id="leadName" placeholder="Enter your name" onchange="autoSave()">
                </div>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
            </div>
        </div>
        <!-- This content div is now a sibling of the header, not a parent -->
        <div class="content">
            <div class="section-controls" style="padding-bottom: 20px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-secondary btn-sm" onclick="expandAllSections()" title="Expand all sections" style="padding: 8px 12px; font-size: 0.9em;">Expand All</button>
                <button class="btn btn-secondary btn-sm" onclick="collapseAllSections()" title="Collapse all sections" style="padding: 8px 12px; font-size: 0.9em;">Collapse All</button>
            </div>
            <!-- Section 1: Pre-Work Setup -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>PRE-WORK SETUP</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="checklist-item" data-id="item-0">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.0 Review Communications</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Read and understand all emails from your supervisor</li>
                                        <li>Review any store issue emails</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-1">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.1 Access the "Dump Bin"</div>
                                <div class="item-description">
                                    Your information hub for everything Kompass-related:
                                    <ul>
                                        <li>Navigate to your period/week folder</li>
                                        <li>Review "Considerations" and "Test Set Notes"</li>
                                        <li>Review "Inventory Schedule" and "Strip Installation" dates</li>
                                        <li>Review "Final Kompass Notes" (deleted items, new items, UPC changes, set instructions)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-2">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.2 Download & "Fax" Print Weekly Materials</div>
                                <div class="item-description">
                                    You can send a fax via email to get your documents printed at the store:
                                    <ul>
                                        <li>Download Kompass Notes, Sign-off Sheets, EOD Cover Sheet, backstock and "Not in Set" labels</li>
                                        <li>Email to: <strong>tyson.gauthier@retailodyssey.com</strong></li>
                                        <li>Subject Line: <strong>#StoreNumber</strong> (e.g., #163) - nothing else</li>
                                        <li>Attach documents and send</li>
                                        <li>Wait for confirmation email to pick up at customer service desk</li>
                                        <li>Alternatively: Use subject line <strong>Fax#</strong> followed by the fax number, for example <strong>Fax#18885551234</strong> (include country code)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-3">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.3 Review Schedule in PROD</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Review your schedule before leaving home</li>
                                        <li>Confirm store addresses, directions, and start times</li>
                                        <li>Ensure that you have all materials, notes, and tools required</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-4">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.4 Professional Preparation</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Wear your name tag and Retail Odyssey work shirt</li>
                                        <li>Park at least half a dozen spaces from the store entrance (leave prime parking for customers)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-5">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.5 Arrive Early & Coordinate Entry</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Arrive at least 1 hour before the team</li>
                                        <li>Coordinate with store personnel for early entry</li>
                                        <li>Typically, we use the grocery receiving door at the back of the building.</li>
                                        <li>Get organized and review the day's plan</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-6">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <!-- UPDATED: EOD text -->
                                <div class="item-title">1.6 Locate the Kompass Box & Take Kompass Cart Photo <span class="eod-highlight">EOD Cover Sheet</span></div>
                                <div class="item-description">
                                    <ul>
                                        <li>White box with blue lettering containing label strips</li>
                                        <li>Check: price change room, office, Kompass cart, receiver's desk</li>
                                        <li>If missing: Use "Vestcom Box Tracking" file in dump bin</li>
                                        <li>While at the cart, take a "before" photo in PROD (Maintenance category) of the Kompass cart, before work starts</li>
                                    </ul>

                                    <div class="eod-field">
                                        <label>Before picture of KOMPASS cart loaded to KOMPASS Maintenance line?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodBeforePhotoYes" name="beforePicPosted" value="Yes" onchange="toggleRadio('beforePicPosted')">
                                                <label for="eodBeforePhotoYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodBeforePhotoNo" name="beforePicPosted" value="No" onchange="toggleRadio('beforePicPosted')">
                                                <label for="eodBeforePhotoNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-7">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.7 Organize Strips, Planograms & Materials</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Arrange strips and planograms on check stand or preferred area</li>
                                        <li>Speak with the head cashier (red vest) about using the space and when to move</li>
                                        <li>Use the strip manifest to record the aisle number on the front of the planogram</li>
                                        <li>Separate and organize POGs and strips, and include the UPLs/price tags</li>
                                        <li>Confirm they are for the correct store number</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-8">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.8 Report No Shows by 7:00 AM</div>
                                <div class="item-description">
                                    Report any no-calls/no-shows to your supervisor by 7:00 AM
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-9">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">1.9 Report Missing COMs (Commodities) by 7:00 AM</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Report categories that are missing from PROD to your supervisor by 7:00 AM</li>
                                        <li>Ensure you cross-reference any remodel projects or strip installations occurring at that store by accessing the folder in the dump bin</li>
                                        <li>Your supervisor may have provided you with this information verbally or in an email.</li>
                                        <li>Ensure you provide your supervisor with the category number, the category name, the version number, the footage, and the DBKey</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Collapse Button at the bottom (This has been removed and will be added by JavaScript) -->
                </div>
            </div>

            <!-- Section 2: During Work -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>DURING WORK</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="checklist-item" data-id="item-10">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.0 Complete Required Surveys First</div>
                                <div class="item-description">
                                    Complete all surveys that aren't directly linked to a set being reset on the first morning of each store visit
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-11">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <!-- UPDATED: EOD text -->
                                <div class="item-title">2.1 Check In with PIC by 7:00 AM and Record Name <span class="eod-highlight">EOD Cover Sheet</span></div>
                                <div class="item-description">
                                    Check in with the person in charge (PIC) by 7:00 AM and record their name
                                    
                                    <div class="eod-field">
                                        <label>Manager's name you checked in with:</label>
                                        <!-- ADDED onchange handler -->
                                        <input type="text" id="checkInManager" placeholder="Enter manager's name" onchange="autoSave()">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-12">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.2 Take "Before" Pictures of All Sets in PROD</div>
                                <div class="item-description">
                                    Take before pictures of all sets in PROD immediately after assigning first sets
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-13">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.3 Plan the Day Strategically</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Assign and start priority sets in order: cut-ins, fresh/fuel sets, then largest backlog sets</li>
                                        <li>Once priority and backlog sets are complete, begin current sets</li>
                                        <li>Identify large/time-intensive sets from Kompass Notes</li>
                                        <li>Contact department heads for coordination</li>
                                        <li>Ask about preferred days/timing (non-load days)</li>
                                        <li><strong>Complete priority and fuel sets first and close them out by 9:00 AM</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-14">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.4 Coordinate with Vendors</div>
                                <div class="item-description">
                                    Notify vendor reps in advance (Coke, Pepsi, Dr. Pepper, Columbia/Frito Lay, Tim's, Mission, etc.)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-15">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.5 Maintain Professional Relationships</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Adjust approach for each store</li>
                                        <li>Build positive relationships with staff</li>
                                        <li>Communicate clearly and respectfully with all personnel</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-16">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.6 Assign Sets Fairly</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Consider experience level, aptitude, and strengths</li>
                                        <li>Avoid favoritism - don't repeatedly assign difficult sets to same person</li>
                                        <li>Assign based on ability, not preference</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-17">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.7 Verify Correct Planogram and Setup</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Verify correct planogram for that store's section and size</li>
                                        <li>Confirm proper number of shelves and shelf heights</li>
                                        <li>Limit to 2 people per 12 feet of set</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-18">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.8 Pull Discontinued Items</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Pull discontinued (DI) items as noted in Kompass Notes and planograms</li>
                                        <li>Use banana boxes and label clearly with appropriate labels</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-19">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.9 Maintain Shopper-Friendly Aisles</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Keep all carts, ladders, and boxes to one side of the aisle</li>
                                        <li>Work in 4-foot sections to maintain accessibility during store hours</li>
                                        <li>Maintain a clean aisle at all times</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-20">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.10 Remove Old Strips and Install New Ones</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Remove old shelf strips and install new ones per planogram</li>
                                        <li>Replace channel strips/data skins as needed</li>
                                        <li>Set category according to updated planogram</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-21">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.11 Rotate Stock Properly</div>
                                <div class="item-description">
                                    Place older items at the front and newer items at the back
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-22">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.12 Track Time and Manage Workflow</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Keep track of time - monitor progress against schedule</li>
                                        <li>Sets should be completed within time estimations</li>
                                        <li>If set exceeds allotted time: Use comment bubble in PROD and report to supervisor</li>
                                        <li>Explanation must be concise (5 words or less): training, lots of overstock, shelves needed cleaning, etc.</li>
                                        <li>Track participation: Use 1st page of Kompass Notes with initials and times</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-23">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.13 Handle New Items from Kompass Cart</div>
                                <div class="item-description">
                                    Ensure new items are taken from the Kompass cart or other designated new item location
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-24">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.14 Clean Shelving and Hang Tags</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Clean shelving and tag moldings where movement occurs</li>
                                        <li>Hang all tags provided or handwrite missing tags as needed</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-25">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.15 Organize Back Stock</div>
                                <div class="item-description">
                                    <ul>
                                        <li>Back stock should be boxed in banana boxes</li>
                                        <li>Palletize and label clearly</li>
                                        <li>Label "Overstock" and "Not in Set" items with appropriate labels</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-26">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.16 Take "After" Pictures in PROD</div>
                                <div class="item-description">
                                    Take after pictures immediately after each set is fully complete:
                                    <ul>
                                        <li>All strips in, shelves adjusted, tags hung, new items placed</li>
                                        <li>"Overstock" and "Not in Set" items labeled and organized</li>
                                        <li>If a set cannot be completed, the exception needs to be the same in both PROD and SI and there needs to be a comment in the comment bubble in PROD and a mention in your EOD Email</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-27">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.17 Take "After" Photos in Store Intelligence</div>
                                <div class="item-description">
                                    After photos - Immediately after each set is fully complete:
                                    <ul>
                                        <li>Bay by bay for each set take a photo</li>
                                        <li>Clear exceptions through the actions section</li>
                                        <li>Ensure all sets completed in PROD are completed in Store Intelligence</li>
                                        <li><strong>This needs to be done prior to leaving the store</strong></li>
                                        <li>If a set cannot be completed, the exception needs to be the same in both PROD and SI and there needs to be a comment in the comment bubble in PROD and a mention in your EOD Email</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-28">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.18 Sync Tablet Frequently</div>
                                <div class="item-description">
                                    Resync after completing major tasks, surveys, and uploading pictures
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-29">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <!-- UPDATED: EOD text -->
                                <div class="item-title">2.19 Handle Issues and Contact Support if Needed <span class="eod-highlight">EOD Cover Sheet</span></div>
                                <div class="item-description">
                                    If problems occur (incorrect planogram, wrong footage, fixture issues, store refusal):
                                    <ul>
                                        <li>First, contact your supervisor and inform them of the issue</li>
                                        <li>Get name and title of person refusing the set or details of the issue</li>
                                        <li>Your supervisor may request you contact Kompass support: <strong>kompass@retailodyssey.com</strong> (CC supervisor)</li>
                                    </ul>
                                    
                                    <div class="eod-field">
                                        <label>Did you call or e-mail the KOMPASS Hotline?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodHotlineYes" name="calledHotline" value="Yes" onchange="toggleHotlineFields(this)">
                                                <label for="eodHotlineYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodHotlineNo" name="calledHotline" value="No" onchange="toggleHotlineFields(this)">
                                                <label for="eodHotlineNo">No</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="hotlineDetails" style="display: none;">
                                        <div class="eod-field">
                                            <label>If so, what commodities are involved?</label>
                                            <!-- ADDED onchange handler -->
                                            <input type="text" id="issueCommodities" placeholder="Enter commodities" onchange="autoSave()">
                                        </div>

                                        <div class="eod-field">
                                            <label>What is the issue?</label>
                                            <!-- ADDED onchange handler -->
                                            <textarea id="issueDescription" placeholder="Describe the issue" onchange="autoSave()"></textarea>
                                        </div>

                                        <div class="eod-field">
                                            <label>Was the issue resolved before EOD?</label>
                                            <div class="checkbox-group">
                                                <div class="checkbox-option">
                                                    <input type="checkbox" id="eodResolvedYes" name="issueResolved" value="Yes" onchange="toggleResolutionField(this)">
                                                    <label for="eodResolvedYes">Yes</label>
                                                </div>
                                                <div class="checkbox-option">
                                                    <input type="checkbox" id="eodResolvedNo" name="issueResolved" value="No" onchange="toggleResolutionField(this)">
                                                    <label for="eodResolvedNo">No</label>
                                                </div>
                                                <div class="checkbox-option">
                                                    <input type="checkbox" id="eodResolvedNA" name="issueResolved" value="NA" onchange="toggleResolutionField(this)">
                                                    <label for="eodResolvedNA">N/A</label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="eod-field" id="tempSolutionField" style="display: none;">
                                            <label>If not, what was the temporary solution?</label>
                                            <!-- ADDED onchange handler -->
                                            <textarea id="tempSolution" placeholder="Describe temporary solution" onchange="autoSave()"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-30">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">2.20 Final Set Verification</div>
                                <div class="item-description">
                                    Confirm the area is left clean, organized, and safe
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Collapse Button at the bottom (This has been removed and will be added by JavaScript) -->
                </div>
            </div>

            <!-- Section 3: End of Day -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>END OF DAY</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-content">
                    <div class="checklist-item" data-id="item-31">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <!-- UPDATED: EOD text -->
                                <div class="item-title">3.1 Walk Sets and Complete Sign-Offs <span class="eod-highlight">EOD Cover Sheet</span></div>
                                <div class="item-description">
                                    <ul>
                                        <li>Walk each set with store personnel to verify completion</li>
                                        <li>Show them where you placed overstock/discontinued items</li>
                                        <li>Complete and review Kompass Sign-Off sheets with store representative</li>
                                        <li>Before giving them their copy, take a photo of the sign-off sheet for records</li>
                                        <li>Leave a signed copy with them</li>
                                        <li>Ask them to complete Kompass Completion online</li>
                                        <li>Record the name of the person you checked out with</li>
                                    </ul>

                                    <div class="eod-field">
                                        <label>Manager's name you checked out with:</label>
                                        <!-- ADDED onchange handler -->
                                        <input type="text" id="checkOutManager" placeholder="Enter manager's name" onchange="autoSave()">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-32">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <!-- UPDATED: EOD text -->
                                <div class="item-title">3.2 Complete PROD and SI <span class="eod-highlight">EOD Cover Sheet</span></div>
                                <div class="item-description">
                                    Verify all sets are signed off in both systems
                                    
                                    <div class="eod-field">
                                        <label>Did all sets get signed out in PROD?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodProdYes" name="signedOutPROD" value="Yes" onchange="toggleRadio('signedOutPROD')">
                                                <label for="eodProdYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodProdNo" name="signedOutPROD" value="No" onchange="toggleRadio('signedOutPROD')">
                                                <label for="eodProdNo">No</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="eod-field">
                                        <label>Did all sets get signed out in SI?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodSiYes" name="signedOutSI" value="Yes" onchange="toggleRadio('signedOutSI')">
                                                <label for="eodSiYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodSiNo" name="signedOutSI" value="No" onchange="toggleRadio('signedOutSI')">
                                                <label for="eodSiNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-33">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <!-- UPDATED: EOD text -->
                                <div class="item-title">3.3 Sign-Off Sheet Documentation <span class="eod-highlight">EOD Cover Sheet</span></div>
                                <div class="item-description">
                                    Ensure proper documentation of sign-off sheets

                                    <div class="eod-field">
                                        <label>Sign out sheet attached to EOD email?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodEmailSheetYes" name="signoutEmail" value="Yes" onchange="toggleRadio('signoutEmail')">
                                                <label for="eodEmailSheetYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodEmailSheetNo" name="signoutEmail" value="No" onchange="toggleRadio('signoutEmail')">
                                                <label for="eodEmailSheetNo">No</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="eod-field">
                                        <label>Sign out sheet attached to KOMPASS Maintenance line in PROD?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodProdSheetYes" name="signoutPROD" value="Yes" onchange="toggleRadio('signoutPROD')">
                                                <label for="eodProdSheetYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodProdSheetNo" name="signoutPROD" value="No" onchange="toggleRadio('signoutPROD')">
                                                <label for="eodProdSheetNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-34">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <!-- UPDATED: EOD text -->
                                <div class="item-title">3.4 Kompass Cart "After" Photos <span class="eod-highlight">EOD Cover Sheet</span></div>
                                <div class="item-description">
                                    Take clear, in-focus photos of Kompass cart

                                    <div class="eod-field">
                                        <label>After picture of KOMPASS cart loaded to KOMPASS Maintenance line?</label>
                                        <div class="checkbox-group">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodAfterPhotoYes" name="afterPicPosted" value="Yes" onchange="toggleRadio('afterPicPosted')">
                                                <label for="eodAfterPhotoYes">Yes</label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="eodAfterPhotoNo" name="afterPicPosted" value="No" onchange="toggleRadio('afterPicPosted')">
                                                <label for="eodAfterPhotoNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-35">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.5 Final Quality Check</div>
                                <div class="item-description">
                                    Verify all pictures are clear, well-lit, in focus, and properly attached
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-36">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.6 Compose the EOD Email</div>
                                <div class="item-description">
                                    <ul>
                                        <li><strong>To:</strong> Fred Meyer PIC + store management</li>
                                        <li><strong>CC:</strong> See email list below</li>
                                        <li><strong>Subject:</strong> EOD FM### MM/DD/YYYY</li>
                                        <li><strong>Attachments:</strong> Quality photos of all Sign-off sheets and EOD Cover Sheet</li>
                                    </ul>
                                    <div class="email-list">
                                        <h4>EOD Email CC List:</h4>
                                        <ul>
                                            <li>mashabranner@retailodyssey.com</li>
                                            <li>seth.newman@retailodyssey.com</li>
                                            <li>knix@retailodyssey.com</li>
                                            <li>yoursupervisor@retailodyssey.com</li>
                                            <li>yourself@retailodyssey.com</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-item" data-id="item-37">
                        <div class="item-header">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" onchange="updateProgress()">
                            </div>
                            <div class="item-content">
                                <div class="item-title">3.7 Final Time Requirements</div>
                                <div class="item-description">
                                    <strong>Ensure that:</strong>
                                    <ul>
                                        <li>All work is completed by <strong>2:30 PM</strong></li>
                                        <li>EOD emails sent by <strong>3:00 PM</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Collapse Button at the bottom (This has been removed and will be added by JavaScript) -->
                </div>
            </div>

            <!-- Notes Section -->
            <div class="notes-section">
                <h3>NOTES & ISSUES:</h3>
                <!-- ADDED onchange handler -->
                <textarea id="notes" placeholder="Enter any notes, issues, or observations here..." onchange="autoSave()"></textarea>
            </div>

            <!-- Signature Section - Moved to the end -->
            <div class="signature-section">
                <label class="signature-label">Lead Signature:</label>
                <canvas id="signaturePad" class="signature-canvas"></canvas>
                <button class="btn-clear-sig" onclick="clearSignature()">Clear Signature</button>
                <button class="btn-clear-sig" onclick="document.getElementById('sigUpload').click()" style="margin-left: 10px;">Upload Signature</button>
                <input type="file" id="sigUpload" accept="image/png, image/jpeg" style="display: none;" onchange="loadSignature(event)">
            </div>

            <!-- Action Buttons -->
            <div class="button-group">

                <div class="toggle-switch">
                    <label class="toggle-switch-wrapper">
                        <input type="checkbox" id="notesOnlyToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <label class="toggle-switch-label" for="notesOnlyToggle">Send "Notes Only" Report</label>
                </div>
                <button class="btn btn-success" onclick="generateEODAndEmail()">Generate & Open Email</button>
                <button class="btn btn-primary" onclick="generateEODCoverSheet()">Generate PDF Only</button>
                <button class="btn btn-primary" onclick="generateEODImage()">Generate Image Only</button>
                <button class="btn btn-secondary" onclick="resetChecklist()">Reset Checklist</button>
            </div>

    <!-- NEW LOADING OVERLAY HTML -->
    <div id="loadingOverlay" class="loading-overlay">
        <span>Generating Image, please wait...</span>
    </div>

    <!-- NEW CUSTOM ALERT/CONFIRM MODAL -->
    <div id="customModal" class="custom-modal-overlay">
        <div class="custom-modal-dialog">
            <h2 id="customModalTitle">Modal Title</h2>
            <p id="customModalMessage">Modal message goes here.</p>
            <div class="custom-modal-buttons">
                <button class="btn btn-secondary" id="customModalCancel">Cancel</button>
                <button class="btn btn-primary" id="customModalConfirm">OK</button>
            </div>
        </div>
    </div>
    <div id="disclaimerModal" class="custom-modal-overlay">
        <div class="custom-modal-dialog" style="max-width: 600px;">
            <h2 id="customModalTitle">⚠️ Important: Please Read Before Use!</h2>
            
            <div class="disclaimer-content">
                <p>Welcome to the Retail Odyssey KOMPASS Lead Daily Checklist!<br>
                Before you begin, please understand and acknowledge the following:</p>

                <h3>This is a Living Document</h3>
                <p>Much like the dynamic nature of your role as a KOMPASS Lead, this checklist is fluid and ever-evolving. Don't expect it to stay the same—it will be updated as processes improve and new insights are gained.</p>

                <h3>It's a Guide, Not a Rulebook</h3>
                <p>I've compiled a list of the primary steps and processes to help you navigate your day successfully. However, I know pieces are missing, and I'm not perfect—nor do I expect you to be. Use this as a tool and a guide, not as an inflexible set of rules.<br>
                This is not an exhaustive list, and your supervisor or other management members may request tasks that seem to contradict this information. Every situation is unique, and I couldn't possibly cover every scenario.</p>

                <h3>Your Feedback Matters</h3>
                <p>If you notice something missing, unclear, or out of order, please share that feedback. Your real-world experience is invaluable in making this resource better for everyone.</p>

                <h3>Every Situation is Different</h3>
                <p>Every store, every day, and every lead has a slightly different process. Don't get stuck on specific wording or the exact order of items. If a step doesn't fit your situation or you need to do things in a different order, use your logic, common sense, and best practices to:</p>
                <ul>
                    <li>Ask questions of your supervisor first.</li>
                    <li>Arrive at a solution independently based on your training and experience, and present your solution to your supervisor for approval.</li>
                </ul>

                <h3>Limitation of Liability</h3>
                <p>By using this checklist, you acknowledge and agree that:</p>
                <ul>
                    <li>You understand that this is a tool that was created to support your successful and timely completion of your daily tasks and responsibilities.</li>
                    <li>You will not hold me or anyone else responsible for the information contained within.</li>
                    <li>You will use your professional judgment and follow your official training and company guidelines when making decisions that are not included in this guide.</li>
                </ul>
                <p>If you understand these points and use the checklist as the helpful tool it's meant to be, it will serve you well in navigating your responsibilities.</p>
            </div>

            <div class="disclaimer-agree">
                <input type="checkbox" id="disclaimerCheckbox">
                <label for="disclaimerCheckbox">I have read, understand, and agree to the above disclaimer</label>
            </div>

            <div class="custom-modal-buttons">
                <button class="btn btn-primary" id="disclaimerConfirm" disabled>Continue</button>
            </div>
        </div>
    </div>
    <!-- EASTER EGG: Quick EOD modal (revealed by clicking header logo) -->
    <style>
    .custom-modal-overlay {
        opacity: 0;
        transition: opacity 0.35s cubic-bezier(.4,0,.2,1);
        pointer-events: none;
    }
    .custom-modal-overlay.show {
        opacity: 1;
        pointer-events: auto;
    }
    .btn {
        transition: box-shadow 0.2s, transform 0.2s;
    }
    .btn:hover {
        box-shadow: 0 4px 16px rgba(136,196,237,0.18);
        transform: translateY(-2px) scale(1.04);
    }
    </style>
    <div id="easterEggOverlay" class="custom-modal-overlay">
        <div class="custom-modal-dialog" style="max-width:700px; width: 95%;">
            <h2>Quick EOD — Cover Sheet Fields</h2>
            <div id="easterEggContent" style="max-height:60vh; overflow:auto; padding-top:8px;"></div>
            <div style="margin-top:18px;">
                <label class="signature-label" style="color:#88c4ed; font-weight:600;">Signature (EOD Quick View):</label>
                <canvas id="easterEggSignaturePad" class="signature-canvas" style="background:white; width:100%; height:188px; display:block; margin-bottom:8px;"></canvas>
                <button class="btn-clear-sig" id="easterEggClearSig">Clear Signature</button>
                <button class="btn-clear-sig" id="easterEggUploadSig" style="margin-left:10px;">Upload Signature</button>
                <input type="file" id="easterEggSigUpload" accept="image/png, image/jpeg" style="display:none;" />
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                <button class="btn btn-secondary" id="easterEggClose">Close</button>
                <button class="btn btn-success" id="easterEggImage">Generate Image</button>
                <button class="btn btn-primary" id="easterEggPdf">Generate PDF</button>
            </div>
        </div>
    </div>
    <script>
        const PDF_FILE = 'End%20Of%20Day%20Cover%20Sheet%20Form%20Editable%20Template.pdf';
        const pdfUrl = `${PDF_FILE}?v=${(crypto?.randomUUID?.() || Date.now())}`;

        // Set today's date by default
        document.getElementById('workDate').valueAsDate = new Date();

        // Load saved data on page load
        window.onload = function() {
            // Setup PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            
            // Run all startup tasks
            loadProgress();
            updateProgress();
            // This line was in your first, deleted function
            document.getElementById('workDate').valueAsDate = new Date();

            // Disclaimer Logic
            const disclaimerModal = document.getElementById('disclaimerModal');
            const disclaimerCheckbox = document.getElementById('disclaimerCheckbox');
            const disclaimerConfirm = document.getElementById('disclaimerConfirm');

            // Check if user has seen the disclaimer
            if (localStorage.getItem('hasSeenDisclaimer') !== 'true') {
                disclaimerModal.classList.add('show');
            }

            // Enable/disable button based on checkbox
            disclaimerCheckbox.addEventListener('change', () => {
                if (disclaimerCheckbox.checked) {
                    disclaimerConfirm.disabled = false;
                } else {
                    disclaimerConfirm.disabled = true;
                }
            });

            // Save agreement and hide modal
            disclaimerConfirm.addEventListener('click', () => {
                localStorage.setItem('hasSeenDisclaimer', 'true');
                disclaimerModal.classList.remove('show');
            });
            
            // --- NEW LOGIC FROM USER'S UPLOADED FILE ---
            // Add a bottom-toggle ("Collapse") button to each section content
            document.querySelectorAll('.section').forEach(section => {
                const header = section.querySelector('.section-header');
                const content = section.querySelector('.section-content');
                if (!header || !content) return;

                // Create container for bottom actions
                const bottomWrap = document.createElement('div');
                bottomWrap.style.display = 'flex';
                bottomWrap.style.justifyContent = 'flex-end';
                bottomWrap.style.marginTop = '12px';
                bottomWrap.style.borderTop = '1px solid #4b5563'; /* gray-600 */
                bottomWrap.style.paddingTop = '12px';
                bottomWrap.className = 'section-footer-collapse'; // Added class for print styles

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-secondary section-bottom-toggle';
                btn.style.padding = '8px 16px'; // Make it smaller
                btn.style.fontSize = '0.9em';
                btn.textContent = 'Collapse Section';

                // Add the click listener from user's file
                btn.addEventListener('click', () => {
                    // Call the global toggleSection function
                    toggleSection(header);
                    
                    // Scroll header into view ONLY when collapsing
                    if (section.classList.contains('collapsed')) {
                        header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });

                bottomWrap.appendChild(btn);
                content.appendChild(bottomWrap);
            });

            // Improve visual alignment for checklist items in PRE-WORK section
            const firstSection = document.querySelector('.content .section');
            if (firstSection) {
                firstSection.querySelectorAll('.item-header').forEach(itemHeader => {
                    itemHeader.style.alignItems = 'center';
                });
                firstSection.querySelectorAll('.item-title').forEach(title => {
                    title.style.display = 'block';
                });
            }
            // --- END NEW LOGIC ---
            
            // --- NEW: Adjust container padding-top dynamically based on header height ---
            function adjustBodyPadding() {
                const header = document.querySelector('.header');
                if (header) {
                    const headerHeight = header.offsetHeight;
                    document.body.style.paddingTop = `${headerHeight}px`;
                }
            }
            adjustBodyPadding();
            window.addEventListener('resize', adjustBodyPadding);
            // --- END NEW ---
        };

        function toggleSection(header) {
            const section = header.closest('.section'); // Use closest to be safe
            const content = section.querySelector('.section-content');
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                content.style.display = 'none';
            } else {
                content.style.display = 'block';
            }
        }
        
        // --- REPLACED FUNCTIONS for Expand/Collapse All (from user's file) ---
        window.expandAllSections = function() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('collapsed');
                const content = section.querySelector('.section-content');
                if (content) content.style.display = 'block';
            });
        };
        window.collapseAllSections = function() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('collapsed');
                const content = section.querySelector('.section-content');
                if (content) content.style.display = 'none';
            });
        };
        // --- END REPLACED FUNCTIONS ---

        // Radio button simulation - ensure only one checkbox per group is checked
        function toggleRadio(groupName) {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
            // Find the checkbox in this group that is currently checked (the one that changed)
            const clickedBox = document.querySelector(`input[name="${groupName}"]:checked`);

            if (clickedBox) {
                checkboxes.forEach(box => {
                    if (box !== clickedBox) {
                        box.checked = false;
                    }
                });
            }

            autoSave();
        }

        // --- ADDED MISSING FUNCTIONS ---

        function autoSave() {
            const data = {
                storeNumber: document.getElementById('storeNumber').value,
                date: document.getElementById('workDate').value,
                leadName: document.getElementById('leadName').value,
                notes: document.getElementById('notes').value,
                checkInManager: document.getElementById('checkInManager').value,
                checkOutManager: document.getElementById('checkOutManager').value,
                issueCommodities: document.getElementById('issueCommodities').value,
                issueDescription: document.getElementById('issueDescription').value,
                tempSolution: document.getElementById('tempSolution').value,
                eodHotlineYes: document.getElementById('eodHotlineYes').checked,
                eodHotlineNo: document.getElementById('eodHotlineNo').checked,
                eodResolvedYes: document.getElementById('eodResolvedYes').checked,
                eodResolvedNo: document.getElementById('eodResolvedNo').checked,
                eodResolvedNA: document.getElementById('eodResolvedNA').checked,
                eodProdYes: document.getElementById('eodProdYes').checked,
                eodProdNo: document.getElementById('eodProdNo').checked,
                eodSiYes: document.getElementById('eodSiYes').checked,
                eodSiNo: document.getElementById('eodSiNo').checked,
                eodEmailSheetYes: document.getElementById('eodEmailSheetYes').checked,
                eodEmailSheetNo: document.getElementById('eodEmailSheetNo').checked,
                eodProdSheetYes: document.getElementById('eodProdSheetYes').checked,
                eodProdSheetNo: document.getElementById('eodProdSheetNo').checked,
                eodBeforePhotoYes: document.getElementById('eodBeforePhotoYes').checked,
                eodBeforePhotoNo: document.getElementById('eodBeforePhotoNo').checked,
                eodAfterPhotoYes: document.getElementById('eodAfterPhotoYes').checked,
                eodAfterPhotoNo: document.getElementById('eodAfterPhotoNo').checked,
                signature: canvas.toDataURL('image/png'),
                checkedItems: Array.from(document.querySelectorAll('.checklist-item input[type="checkbox"]:not([name])')).map(cb => cb.checked)
            };
            
            localStorage.setItem('kompassChecklist', JSON.stringify(data));
        }

        function updateProgress() {
            // Get all main checkboxes (not EOD field checkboxes)
            const mainCheckboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]:not([name])');
            let totalItems = mainCheckboxes.length;
            let completedItems = 0;

            mainCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    completedItems++;
                }
            });

            // Add EOD-specific checkboxes/fields to the count
            const eodFields = [
                'beforePicPosted', 'checkInManager', 'calledHotline',
                'checkOutManager', 'signedOutPROD', 'signedOutSI',
                'signoutEmail', 'signoutPROD', 'afterPicPosted'
            ];

            eodFields.forEach(fieldName => {
                if (fieldName === 'checkInManager' || fieldName === 'checkOutManager') {
                    // Text input fields
                    const field = document.getElementById(fieldName);
                    if (field && field.value.trim() !== '') {
                        completedItems++;
                    }
                    totalItems++;
                } else {
                    // Radio button groups
                    const checked = document.querySelector(`input[name="${fieldName}"]:checked`);
                    if (checked) {
                        completedItems++;
                    }
                    totalItems++;
                }
            });

            // Only count hotline details if hotline was called
            const hotlineYes = document.getElementById('eodHotlineYes');
            if (hotlineYes && hotlineYes.checked) {
                const commoditiesField = document.getElementById('issueCommodities');
                const issueField = document.getElementById('issueDescription');
                const resolvedChecked = document.querySelector('input[name="issueResolved"]:checked');

                if (commoditiesField && commoditiesField.value.trim() !== '') completedItems++;
                totalItems++;

                if (issueField && issueField.value.trim() !== '') completedItems++;
                totalItems++;

                if (resolvedChecked) completedItems++;
                totalItems++;

                // Only count temp solution if issue was not resolved
                const resolvedNo = document.getElementById('eodResolvedNo');
                if (resolvedNo && resolvedNo.checked) {
                    const tempSol = document.getElementById('tempSolution');
                    if (tempSol && tempSol.value.trim() !== '') completedItems++;
                    totalItems++;
                }
            }

            const percentage = (totalItems > 0) ? Math.round((completedItems / totalItems) * 100) : 0;
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            // Update completed styling
            mainCheckboxes.forEach(checkbox => {
                const item = checkbox.closest('.checklist-item');
                if (checkbox.checked) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            });

            // Auto-save when checking/unchecking
            autoSave();
        }

        function toggleHotlineFields(checkbox) {
            const yesBox = document.getElementById('eodHotlineYes');
            const noBox = document.getElementById('eodHotlineNo');
            const detailsDiv = document.getElementById('hotlineDetails');
            
            // Toggle mutual exclusivity
            if (checkbox.id === 'eodHotlineYes' && checkbox.checked) {
                noBox.checked = false;
                detailsDiv.style.display = 'block';
            } else if (checkbox.id === 'eodHotlineNo' && checkbox.checked) {
                yesBox.checked = false;
                detailsDiv.style.display = 'none';
            } else if (!yesBox.checked && !noBox.checked) {
                detailsDiv.style.display = 'none';
            }
            
            updateProgress();
            autoSave();
        }

        function toggleResolutionField(checkbox) {
            const yesBox = document.getElementById('eodResolvedYes');
            const noBox = document.getElementById('eodResolvedNo');
            const naBox = document.getElementById('eodResolvedNA');
            const tempField = document.getElementById('tempSolutionField');
            
            // Toggle mutual exclusivity
            if (checkbox.id === 'eodResolvedYes' && checkbox.checked) {
                noBox.checked = false;
                naBox.checked = false;
                tempField.style.display = 'none';
            } else if (checkbox.id === 'eodResolvedNo' && checkbox.checked) {
                yesBox.checked = false;
                naBox.checked = false;
                tempField.style.display = 'block';
            } else if (checkbox.id === 'eodResolvedNA' && checkbox.checked) {
                yesBox.checked = false;
                noBox.checked = false;
                tempField.style.display = 'none';
            }
            
            updateProgress();
            autoSave();
        }
        
        // --- END ADDED MISSING FUNCTIONS ---

        function loadProgress() {
            const saved = localStorage.getItem('kompassChecklist');
            if (saved) {
                const data = JSON.parse(saved);
                
                if (data.storeNumber) document.getElementById('storeNumber').value = data.storeNumber;
                if (data.date) document.getElementById('workDate').value = data.date;
                if (data.leadName) document.getElementById('leadName').value = data.leadName;
                if (data.notes) document.getElementById('notes').value = data.notes;
                if (data.checkInManager) document.getElementById('checkInManager').value = data.checkInManager;
                if (data.checkOutManager) document.getElementById('checkOutManager').value = data.checkOutManager;
                if (data.eodHotlineYes) document.getElementById('eodHotlineYes').checked = true;
                if (data.eodHotlineNo) document.getElementById('eodHotlineNo').checked = true;
                if (data.issueCommodities) document.getElementById('issueCommodities').value = data.issueCommodities;
                if (data.issueDescription) document.getElementById('issueDescription').value = data.issueDescription;
                if (data.eodResolvedYes) document.getElementById('eodResolvedYes').checked = true;
                if (data.eodResolvedNo) document.getElementById('eodResolvedNo').checked = true;
                if (data.eodResolvedNA) document.getElementById('eodResolvedNA').checked = true;
                if (data.tempSolution) document.getElementById('tempSolution').value = data.tempSolution;
                if (data.eodProdYes) document.getElementById('eodProdYes').checked = true;
                if (data.eodProdNo) document.getElementById('eodProdNo').checked = true;
                if (data.eodSiYes) document.getElementById('eodSiYes').checked = true;
                if (data.eodSiNo) document.getElementById('eodSiNo').checked = true;
                if (data.eodEmailSheetYes) document.getElementById('eodEmailSheetYes').checked = true;
                if (data.eodEmailSheetNo) document.getElementById('eodEmailSheetNo').checked = true;
                if (data.eodProdSheetYes) document.getElementById('eodProdSheetYes').checked = true;
                if (data.eodProdSheetNo) document.getElementById('eodProdSheetNo').checked = true;
                if (data.eodBeforePhotoYes) document.getElementById('eodBeforePhotoYes').checked = true;
                if (data.eodBeforePhotoNo) document.getElementById('eodBeforePhotoNo').checked = true;
                if (data.eodAfterPhotoYes) document.getElementById('eodAfterPhotoYes').checked = true;
                if (data.eodAfterPhotoNo) document.getElementById('eodAfterPhotoNo').checked = true;

                // Show hotline details if yes is checked
                if (data.eodHotlineYes) {
                    document.getElementById('hotlineDetails').style.display = 'block';
                }
                
                // Show temp solution field if issue not resolved
                if (data.eodResolvedNo) {
                    document.getElementById('tempSolutionField').style.display = 'block';
                }

                // Restore signature
                if (data.signature) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.signature;
                }

                // Restore checkbox states
                if (data.checkedItems) {
                    document.querySelectorAll('.checklist-item input[type="checkbox"]:not([name])').forEach((checkbox, index) => {
                        if (data.checkedItems[index]) {
                            checkbox.checked = true;
                        }
                    });
                }
            }
        }

        function resetChecklist() {
            // Use custom confirm
            showCustomConfirm(
                'Reset Checklist',
                'Are you sure you want to reset the checklist? This will clear all saved progress.',
                () => {
                    // This code runs if the user clicks "Yes"
                    localStorage.removeItem('kompassChecklist');
                    
                    // Reset all fields
                    document.getElementById('storeNumber').value = '';
                    document.getElementById('workDate').valueAsDate = new Date();
                    document.getElementById('leadName').value = '';
                    document.getElementById('notes').value = '';
                    
                    // Reset EOD fields
                    document.getElementById('checkInManager').value = '';
                    document.getElementById('checkOutManager').value = '';
                    document.getElementById('eodHotlineYes').checked = false;
                    document.getElementById('eodHotlineNo').checked = false;
                    document.getElementById('issueCommodities').value = '';
                    document.getElementById('issueDescription').value = '';
                    document.getElementById('eodResolvedYes').checked = false;
                    document.getElementById('eodResolvedNo').checked = false;
                    document.getElementById('eodResolvedNA').checked = false;
                    document.getElementById('tempSolution').value = '';
                    document.getElementById('eodProdYes').checked = false;
                    document.getElementById('eodProdNo').checked = false;
                    document.getElementById('eodSiYes').checked = false;
                    document.getElementById('eodSiNo').checked = false;
                    document.getElementById('eodEmailSheetYes').checked = false;
                    document.getElementById('eodEmailSheetNo').checked = false;
                    document.getElementById('eodProdSheetYes').checked = false;
                    document.getElementById('eodProdSheetNo').checked = false;
                    document.getElementById('eodBeforePhotoYes').checked = false;
                    document.getElementById('eodBeforePhotoNo').checked = false;
                    document.getElementById('eodAfterPhotoYes').checked = false;
                    document.getElementById('eodAfterPhotoNo').checked = false;
                    
                    // Clear signature
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Uncheck all checkboxes
                    document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // Hide conditional fields
                    document.getElementById('hotlineDetails').style.display = 'none';
                    document.getElementById('tempSolutionField').style.display = 'none';

                    updateProgress(); // This will also trigger autoSave() with empty data
                }
            );
        }

        // Helper functions for PDF generation
        const pickYN = (v) => {
            if (typeof v === 'string') {
                const s = v.trim().toLowerCase();
                if (s.startsWith('y')) return 'Yes';
                if (s.startsWith('n')) return 'No';
            }
            return v ? 'Yes' : 'No';
        };

        const pickYNN = (v) => {
            if (typeof v === 'string') {
                const s = v.trim().toLowerCase();
                if (s === 'na' || s === 'n/a') return 'NA';
                if (s.startsWith('y')) return 'Yes';
                if (s.startsWith('n')) return 'No';
            }
            if (v === null || v === undefined) return 'NA';
            return v ? 'Yes' : 'No';
        };

        async function embedDataUrl(pdfDoc, dataUrl) {
            if (!dataUrl) return null;
            const res = await fetch(dataUrl);
            const bytes = await res.arrayBuffer();
            const isPng = dataUrl.startsWith('data:image/png');
            return isPng ? await pdfDoc.embedPng(bytes) : await pdfDoc.embedJpg(bytes);
        }

        // REDUNDANT - will be removed
        /*
        function isoDate(d) {
            if (!d) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
            const dt = new Date(d);
            return Number.isNaN(dt) ? '' : dt.toISOString().slice(0,10);
        }
        */

        async function signatureDataURL() {
            const pad = document.getElementById('signaturePad');
            if (pad && pad.toDataURL) {
                const dataUrl = pad.toDataURL('image/png');
                // Check if canvas is empty
                if (dataUrl === 'data:,') return '';
                return dataUrl;
            }
            return '';
        }

        // Signature Pad functionality
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Set canvas size
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // Redraw signature if it exists
            const saved = localStorage.getItem('kompassChecklist');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.signature) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.signature;
                }
            }
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Drawing functions
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const currentX = touch.clientX - rect.left;
            const currentY = touch.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();

            lastX = currentX;
            lastY = currentY;
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                autoSave(); // Save signature when done drawing
            }
        }

        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch events
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);

        // Clear signature function
        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            autoSave();
        }
        function loadSignature(event) {
            const file = event.target.files[0];
            if (!file) {
                return; // No file selected
            }

            // Check if it's an image
            if (!file.type.startsWith('image/')) {
                // Use standard alert
                alert('Error: Please upload an image file (PNG or JPG).');
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Clear the canvas first
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw the uploaded image, stretching it to fill the canvas
                    // This will allow your new auto-cropper to work perfectly
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Save the new signature
                    autoSave();
                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(file);

            // Clear the input value so the same file can be loaded again if needed
            event.target.value = null;
        }
    </script>
    
    <script>
    // --- NEW CUSTOM MODAL SCRIPT ---
    let confirmCallback = null;
    const customModal = document.getElementById('customModal');
    const modalTitle = document.getElementById('customModalTitle');
    const modalMessage = document.getElementById('customModalMessage');
    const modalConfirm = document.getElementById('customModalConfirm');
    const modalCancel = document.getElementById('customModalCancel');

    function showCustomAlert(title, message) {
        modalTitle.textContent = title;
        modalMessage.innerHTML = message; // Use innerHTML to allow <br>
        modalConfirm.textContent = 'OK';
        modalCancel.style.display = 'none';
        customModal.classList.add('show');
        confirmCallback = null;
    }

    function showCustomConfirm(title, message, onConfirm) {
        modalTitle.textContent = title;
        modalMessage.innerHTML = message;
        modalConfirm.textContent = 'Yes';
        modalCancel.style.display = 'inline-block';
        modalCancel.textContent = 'No';
        customModal.classList.add('show');
        confirmCallback = onConfirm;
    }

    modalConfirm.addEventListener('click', () => {
        customModal.classList.remove('show');
        if (confirmCallback) {
            confirmCallback();
            confirmCallback = null;
        }
    });

    modalCancel.addEventListener('click', () => {
        customModal.classList.remove('show');
        confirmCallback = null;
    });
    // --- END CUSTOM MODAL SCRIPT ---
    </script>


    <script>
    // --- EASTER EGG: Quick EOD view logic ---
    function initEasterEgg() {
        const logo = document.getElementById('headerLogo');
        const overlay = document.getElementById('easterEggOverlay');
        const content = document.getElementById('easterEggContent');
        const btnClose = document.getElementById('easterEggClose');
        const btnPdf = document.getElementById('easterEggPdf');
        const btnImage = document.getElementById('easterEggImage');

        if (!logo || !overlay || !content) return;

        // Fields to include in the quick view. Each object maps a label and the id of the main input.
        const fields = [
            {label: 'Store #', id: 'storeNumber', type: 'text'},
            {label: 'Date', id: 'workDate', type: 'date'},
            {label: 'Lead Name', id: 'leadName', type: 'text'},
            {label: 'Before picture of KOMPASS cart?', id: 'beforePicPosted', type: 'yn-checkbox'},
            {label: 'Manager checked in with', id: 'checkInManager', type: 'text'},
            {label: 'Called KOMPASS Hotline?', id: 'calledHotline', type: 'yn-checkbox'},
            {label: 'Commodities (if hotline)', id: 'issueCommodities', type: 'text'},
            {label: 'What is the issue?', id: 'issueDescription', type: 'textarea'},
            {label: 'Was the issue resolved?', id: 'issueResolved', type: 'yna-checkbox'},
            {label: 'Temporary solution (if not resolved)', id: 'tempSolution', type: 'textarea'},
            {label: 'Manager checked out with', id: 'checkOutManager', type: 'text'},
            {label: 'Signed out in PROD?', id: 'signedOutPROD', type: 'yn-checkbox'},
            {label: 'Signed out in SI?', id: 'signedOutSI', type: 'yn-checkbox'},
            {label: 'Sign-out sheet attached to EOD email?', id: 'signoutEmail', type: 'yn-checkbox'},
            {label: 'Sign-out sheet attached to PROD?', id: 'signoutPROD', type: 'yn-checkbox'},
            {label: 'After picture of KOMPASS cart?', id: 'afterPicPosted', type: 'yn-checkbox'},
            {label: 'Notes', id: 'notes', type: 'textarea'},
        ];

        function makeRow(f) {
            const wrapper = document.createElement('div');
            wrapper.style.marginBottom = '10px';

            // Text or date input
            if (f.type === 'text' || f.type === 'date') {
                const el = document.createElement('input');
                el.type = f.type === 'date' ? 'date' : 'text';
                el.placeholder = f.label;
                el.value = document.getElementById(f.id)?.value ?? '';
                el.style.width = '100%';
                el.style.padding = '8px';
                el.style.borderRadius = '4px';
                el.style.background = '#4b5563';
                el.style.color = '#f9fafb';
                el.style.marginBottom = '10px';
                // Style placeholder text
                el.style.setProperty('--placeholder-color', '#aaa');
                el.addEventListener('input', e => {
                    const main = document.getElementById(f.id);
                    if (main) main.value = e.target.value;
                    autoSave();
                });
                wrapper.appendChild(el);
                return wrapper;
            }

            // Textarea
            if (f.type === 'textarea') {
                const ta = document.createElement('textarea');
                ta.placeholder = f.label;
                ta.value = document.getElementById(f.id)?.value ?? '';
                ta.style.width = '100%';
                ta.style.minHeight = '60px';
                ta.style.padding = '8px';
                ta.style.borderRadius = '4px';
                ta.style.background = '#4b5563';
                ta.style.color = '#f9fafb';
                ta.style.marginBottom = '10px';
                ta.addEventListener('input', e => {
                    const main = document.getElementById(f.id);
                    if (main) main.value = e.target.value;
                    autoSave();
                });
                wrapper.appendChild(ta);
                return wrapper;
            }

            // Yes/No or Yes/No/N-A checkbox group (radio-like behavior)
            if (f.type === 'yn-checkbox' || f.type === 'yna-checkbox') {
                const yesId = f.id + 'Yes_egg';
                const noId = f.id + 'No_egg';
                const naId = f.id + 'NA_egg';

                // Add label above the checkbox group
                const groupLabel = document.createElement('div');
                groupLabel.textContent = f.label;
                groupLabel.style.display = 'block';
                groupLabel.style.marginBottom = '8px';
                groupLabel.style.fontWeight = 'bold';
                groupLabel.style.color = '#f9fafb';
                wrapper.appendChild(groupLabel);

                function makeRadioLocal(id, labelText) {
                    const wrap = document.createElement('label');
                    wrap.className = 'custom-radio';
                    wrap.style.display = 'flex';
                    wrap.style.alignItems = 'center';
                    wrap.style.gap = '6px';
                    wrap.style.cursor = 'pointer';
                    let tip = '';
                    if (labelText === 'Yes') tip = 'Select if this is true for today.';
                    if (labelText === 'No') tip = 'Select if this does not apply for today.';
                    if (labelText === 'N/A') tip = 'Select if this is not applicable.';
                    wrap.innerHTML = `<input type='checkbox' id='${id}' style='accent-color:#0d4f8b; width:20px; height:20px;' title='${tip}'> <span title='${tip}'>${labelText}</span>`;
                    return wrap;
                }

                const grp = document.createElement('div');
                grp.style.display = 'flex';
                grp.style.gap = '12px';
                grp.appendChild(makeRadioLocal(yesId, 'Yes'));
                grp.appendChild(makeRadioLocal(noId, 'No'));
                if (f.type === 'yna-checkbox') grp.appendChild(makeRadioLocal(naId, 'N/A'));
                wrapper.appendChild(grp);

                // Initialize states from main inputs
                const mainCheckedYes = document.querySelector(`input[name="${f.id}"][value="Yes"]`)?.checked || false;
                const mainCheckedNo = document.querySelector(`input[name="${f.id}"][value="No"]`)?.checked || false;
                const mainCheckedNA = document.querySelector(`input[name="${f.id}"][value="NA"]`)?.checked || false;

                const yesEl = wrapper.querySelector(`#${yesId}`);
                const noEl = wrapper.querySelector(`#${noId}`);
                const naEl = wrapper.querySelector(`#${naId}`);

                if (mainCheckedYes && yesEl) yesEl.checked = true;
                if (mainCheckedNo && noEl) noEl.checked = true;
                if (f.type === 'yna-checkbox' && mainCheckedNA && naEl) naEl.checked = true;

                const ids = [yesId, noId, naId];
                ids.forEach(id => {
                    const localEl = wrapper.querySelector(`#${id}`);
                    if (!localEl) return;
                    localEl.addEventListener('change', () => {
                        if (localEl.checked) {
                            ids.forEach(otherId => {
                                if (otherId !== id) {
                                    const otherEl = wrapper.querySelector(`#${otherId}`);
                                    if (otherEl) otherEl.checked = false;
                                }
                            });
                        }

                        // Sync to main inputs
                        const mainYes = document.querySelector(`input[name="${f.id}"][value="Yes"]`);
                        const mainNo = document.querySelector(`input[name="${f.id}"][value="No"]`);
                        const mainNA = document.querySelector(`input[name="${f.id}"][value="NA"]`);
                        if (mainYes) mainYes.checked = !!(wrapper.querySelector(`#${yesId}`)?.checked);
                        if (mainNo) mainNo.checked = !!(wrapper.querySelector(`#${noId}`)?.checked);
                        if (mainNA) mainNA.checked = !!(wrapper.querySelector(`#${naId}`)?.checked);

                        // Toggle related conditional UI if needed
                        const mainYesObj = mainYes || { id: 'eodHotlineYes', checked: !!(wrapper.querySelector(`#${yesId}`)?.checked) };
                        const mainNAObj = mainNA || { id: 'eodResolvedNA', checked: !!(wrapper.querySelector(`#${naId}`)?.checked) };
                        if (f.id === 'calledHotline') toggleHotlineFields(mainYesObj);
                        if (f.id === 'issueResolved') toggleResolutionField(mainNAObj);

                        toggleRadio(f.id);
                        autoSave();
                        updateProgress();
                    });
                });

                return wrapper;
            }

            return wrapper;
        }

        function openEasterEgg(){
            content.innerHTML = '';
            fields.forEach(f => content.appendChild(makeRow(f)));

            // --- Signature canvas logic for overlay ---
            const mainCanvas = document.getElementById('signaturePad');
            const eggCanvas = document.getElementById('easterEggSignaturePad');
            const eggClearBtn = document.getElementById('easterEggClearSig');
            const eggUploadBtn = document.getElementById('easterEggUploadSig');
            const eggUploadInput = document.getElementById('easterEggSigUpload');

            // Resize overlay canvas to match main
            function resizeEggCanvas() {
                eggCanvas.width = mainCanvas.width;
                eggCanvas.height = mainCanvas.height;
            }
            resizeEggCanvas();

            // Copy signature from main to overlay
            function copyMainToEgg() {
                try {
                    const data = mainCanvas.toDataURL('image/png');
                    const img = new window.Image();
                    img.onload = function() {
                        const ctx = eggCanvas.getContext('2d');
                        ctx.clearRect(0, 0, eggCanvas.width, eggCanvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data;
                } catch(e) {}
            }
            copyMainToEgg();

            // Drawing logic for overlay canvas
            let isDrawingEgg = false, lastEggX = 0, lastEggY = 0;
            const eggCtx = eggCanvas.getContext('2d');
            function startEggDraw(e) {
                isDrawingEgg = true;
                const rect = eggCanvas.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : e;
                lastEggX = touch.clientX - rect.left;
                lastEggY = touch.clientY - rect.top;
            }
            function drawEgg(e) {
                if (!isDrawingEgg) return;
                e.preventDefault();
                const rect = eggCanvas.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : e;
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                eggCtx.beginPath();
                eggCtx.moveTo(lastEggX, lastEggY);
                eggCtx.lineTo(x, y);
                eggCtx.strokeStyle = '#000';
                eggCtx.lineWidth = 5;
                eggCtx.lineCap = 'round';
                eggCtx.lineJoin = 'round';
                eggCtx.stroke();
                lastEggX = x;
                lastEggY = y;
            }
            function stopEggDraw() {
                if (isDrawingEgg) {
                    isDrawingEgg = false;
                    syncEggToMain();
                }
            }
            eggCanvas.addEventListener('mousedown', startEggDraw);
            eggCanvas.addEventListener('mousemove', drawEgg);
            eggCanvas.addEventListener('mouseup', stopEggDraw);
            eggCanvas.addEventListener('mouseout', stopEggDraw);
            eggCanvas.addEventListener('touchstart', startEggDraw, { passive: false });
            eggCanvas.addEventListener('touchmove', drawEgg, { passive: false });
            eggCanvas.addEventListener('touchend', stopEggDraw);

            // Clear button
            eggClearBtn.onclick = function() {
                eggCtx.clearRect(0, 0, eggCanvas.width, eggCanvas.height);
                syncEggToMain();
            };

            // Upload button
            eggUploadBtn.onclick = function() {
                eggUploadInput.click();
            };
            eggUploadInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    alert('Error: Please upload an image file (PNG or JPG).');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new window.Image();
                    img.onload = function() {
                        eggCtx.clearRect(0, 0, eggCanvas.width, eggCanvas.height);
                        eggCtx.drawImage(img, 0, 0, eggCanvas.width, eggCanvas.height);
                        syncEggToMain();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                event.target.value = null;
            };

            // Sync overlay signature to main canvas and localStorage
            function syncEggToMain() {
                try {
                    const data = eggCanvas.toDataURL('image/png');
                    const ctxMain = mainCanvas.getContext('2d');
                    const img = new window.Image();
                    img.onload = function() {
                        ctxMain.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
                        ctxMain.drawImage(img, 0, 0);
                        autoSave();
                    };
                    img.src = data;
                } catch(e) {}
            }

            overlay.classList.add('show');
        }

        function closeEasterEgg(){ overlay.classList.remove('show'); }

        logo.addEventListener('click', openEasterEgg);
        btnClose?.addEventListener('click', closeEasterEgg);

        // Wire generation buttons to existing functions but keep overlay open/closed behavior
        btnPdf?.addEventListener('click', async () => {
            try{ await window.generateEODCoverSheet(); } catch(e){ console.error(e); }
        });

        btnImage?.addEventListener('click', async () => {
            try{ await window.generateEODAndEmail(); } catch(e){ console.error(e); }
        });
    }

    // Call initEasterEgg after all DOM is loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEasterEgg);
    } else {
        initEasterEgg();
    }
    // --- END EASTER EGG ---
    
    /* * REPLACED isoDate function with a more comprehensive date formatter
     * and a new store number formatter.
     */
    function getFormattedDate(isoDate) {
        if (!isoDate) {
            const d = new Date();
            isoDate = d.toISOString().split('T')[0]; // Use today if empty
        }

        const parts = isoDate.split('-'); // YYYY, MM, DD
        if (parts.length === 3) {
            const [y, m, d] = parts;
            return {
                mmddyyyy: `${m}/${d}/${y}`,
                mm_dd_yyyy: `${m}_${d}_${y}`
            };
        }
        
        // Fallback for unexpected format
        const today = new Date();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        const y = today.getFullYear();
        return {
            mmddyyyy: `${m}/${d}/${y}`,
            mm_dd_yyyy: `${m}_${d}_${y}`
        };
    }

    function getFormattedStoreNum(storeNum) {
        return String(storeNum || '').padStart(3, '0');
    }

async function getSignatureDataURL() {
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // Get all pixel data
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;

        let minX = width, minY = height, maxX = 0, maxY = 0;
        let isEmpty = true;

        // Find the bounds of the signature
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                // Get the alpha (transparency) channel
                const alpha = data[((y * width) + x) * 4 + 3];
                if (alpha > 0) { // If pixel is not transparent
                    isEmpty = false;
                    if (x < minX) minX = x;
                    if (x > maxX) maxX = x;
                    if (y < minY) minY = y;
                    if (y > maxY) maxY = y;
                }
            }
        }

        // If the canvas is empty, return empty
        if (isEmpty) {
            return ''; // No signature
        }

        // Add a little padding to the bounds
        const padding = 10;
        minX = Math.max(0, minX - padding);
        minY = Math.max(0, minY - padding);
        maxX = Math.min(width, maxX + padding);
        maxY = Math.min(height, maxY + padding);

        // Calculate the cropped dimensions
        const cropWidth = maxX - minX;
        const cropHeight = maxY - minY;

        // Create a new temporary canvas
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = cropWidth;
        tempCanvas.height = cropHeight;
        const tempCtx = tempCanvas.getContext('2d');

        // Copy the cropped image data to the new canvas
        tempCtx.drawImage(canvas, minX, minY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

        // Get the data URL from the new, cropped canvas
        return tempCanvas.toDataURL('image/png');
    }

    // ---------- NEW HELPER FUNCTION (Extracted from fillPdf) ----------
    async function createFilledPdfBytes(data) {
        const src = await fetch(pdfUrl).then(r => {
            if (!r.ok) throw new Error('PDF not found. Please ensure the file "End Of Day Cover Sheet Form Editable Template.pdf" is in the same directory as this HTML file.');
            return r.arrayBuffer();
        });

        const pdfDoc = await PDFLib.PDFDocument.load(src);
        const form = pdfDoc.getForm();

        // Text fields (includes WhatIsIssue)
        form.getTextField('LeadName').setText(data.LeadName ?? '');
        // UPDATED: Use the new MM/DD/YYYY date format in the PDF
        form.getTextField('DateISO').setText(data.DateMMDDYYYY ?? '');
        form.getTextField('StoreNumber').setText(String(data.StoreNumber ?? '')); // Use raw store number for PDF field
        form.getTextField('CheckInManager').setText(data.CheckInManager ?? '');
        form.getTextField('IssueCommodities').setText(data.IssueCommodities ?? '');
        form.getTextField('WhatIsIssue').setText(data.WhatIsIssue ?? '');
        form.getTextField('TempSolution').setText(data.TempSolution ?? '');
        form.getTextField('CheckOutManager').setText(data.CheckOutManager ?? '');

        // Radio groups
        form.getRadioGroup('BeforePicPosted').select(pickYN(data.BeforePicPosted));
        form.getRadioGroup('CalledHotline').select(pickYN(data.CalledHotline));
        form.getRadioGroup('IssueResolved').select(pickYNN(data.IssueResolved));
        form.getRadioGroup('SignedOutPROD').select(pickYN(data.SignedOutPROD));
        form.getRadioGroup('SignedOutSI').select(pickYN(data.SignedOutSI));
        form.getRadioGroup('SignoutSheetAttachedEmail').select(pickYN(data.SignoutSheetAttachedEmail));
        form.getRadioGroup('SignoutSheetAttachedPROD').select(pickYN(data.SignoutSheetAttachedPROD));
        form.getRadioGroup('AfterPicPosted').select(pickYN(data.AfterPicPosted));

        // Signature image (Push Button named LeadSignatureImage)
        if (data.signatureDataURL) {
            const img = await embedDataUrl(pdfDoc, data.signatureDataURL);
            if (img) form.getButton('LeadSignatureImage').setImage(img);
        }

        form.flatten();
        return await pdfDoc.save();
    }


    // ---------- OVERRIDES ----------
    // Collect payload (adds WhatIsIssue + hotline "No" cascade to N/A)
   window.collectPayload = async function collectPayload() {
        const v = sel => document.querySelector(sel)?.value ?? '';
        const r = name => (document.querySelector(`input[name="${name}"]:checked`)?.value ?? '');
        const yn = name => r(name).toLowerCase().startsWith('y');

        // NEW: Get formatted date and store number
        const rawDate = v('#workDate');
        const dates = getFormattedDate(rawDate);
        const rawStoreNum = v('#storeNumber');
        const storeNumPadded = getFormattedStoreNum(rawStoreNum);

        const payload = {
            LeadName: v('#leadName'),
            // UPDATED: Add new date and store formats to payload
            DateMMDDYYYY: dates.mmddyyyy,
            DateForFilename: dates.mm_dd_yyyy,
            StoreNumber: rawStoreNum, // The raw number
            StoreNumberPadded: storeNumPadded, // The 3-digit padded number

            CheckInManager: v('#checkInManager'),
            IssueCommodities: v('#issueCommodities'),
            WhatIsIssue: v('#issueDescription'), // Corrected from issueDescription
            TempSolution: v('#tempSolution'),
            CheckOutManager: v('#checkOutManager'),

            BeforePicPosted: yn('beforePicPosted'),
            CalledHotline: yn('calledHotline'),
            IssueResolved: r('issueResolved') || 'NA',
            SignedOutPROD: yn('signedOutPROD'),
            SignedOutSI: yn('signedOutSI'),
            SignoutSheetAttachedEmail: yn('signoutEmail'),
            SignoutSheetAttachedPROD: yn('signoutPROD'),
            AfterPicPosted: yn('afterPicPosted'),

            // This is the line we added
            Notes: v('#notes'), 

            signatureDataURL: await getSignatureDataURL()
        };

        // If hotline was NOT called, normalize related fields to N/A
        if (!payload.CalledHotline) {
            payload.IssueCommodities = 'N/A';
            payload.WhatIsIssue = 'N/A';
            payload.TempSolution = 'N/A';
            payload.IssueResolved = 'NA';
        }

        return payload;
    };

    // Fill the PDF (adds WhatIsIssue and new filename)
    // MODIFIED to use the new helper function
    window.fillPdf = async function fillPdf(data) {
        const out = await createFilledPdfBytes(data); // Use helper
        const blob = new Blob([out], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), {
            href: url,
            // UPDATED: Use new filename format
            download: `EOD Cover Sheet FM${data.StoreNumberPadded || 'store'} ${data.DateForFilename || 'date'}.pdf`
        });
        a.click();
        URL.revokeObjectURL(url);
    };

    // Rebind generator to use the overrides (name unchanged)
    window.generateEODCoverSheet = async function generateEODCoverSheet() {
    try {
        const payload = await window.collectPayload();
        await window.fillPdf(payload);
        showCustomAlert('PDF Generated', 'EOD Cover Sheet PDF generated and downloaded successfully!<br><br>Please review the file and attach it to your EOD email along with sign-off sheets and photos.');
    } catch (error) {
        console.error('Error generating PDF:', error);
        showCustomAlert('Error Generating PDF', error.message + '<br><br>Please ensure the file "End Of Day Cover Sheet Form Editable Template.pdf" is in the same directory as this HTML file.');
    }
    };

    // ---------- NEW IMAGE GENERATION FUNCTION ----------
    window.generateEODImage = async function generateEODImage() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.add('show');
        
        try {
            // 1. Get data and create the filled PDF bytes
            const payload = await window.collectPayload();
            const pdfBytes = await createFilledPdfBytes(payload);

            // 2. Load the PDF bytes into pdf.js
            const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
            const pdfDoc = await loadingTask.promise;
            const page = await pdfDoc.getPage(1); // Get the first page

            // 3. Create a canvas to render the PDF
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // 4. Set canvas size with high resolution (e.g., 2x scale)
            const scale = 2.0;
            const viewport = page.getViewport({ scale: scale });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            // 5. Render the PDF page to the canvas
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;

            // 6. Convert canvas to JPG and trigger download
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9); // 0.9 = 90% quality
            const a = document.createElement('a');
            a.href = dataUrl;
            // UPDATED: Use new filename format
            a.download = `EOD Cover Sheet FM${payload.StoreNumberPadded || 'store'} ${payload.DateForFilename || 'date'}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            showCustomAlert('Image Generated', 'EOD Cover Sheet JPG generated and downloaded successfully!');

        } catch (error) {
            console.error('Error generating JPG:', error);
            showCustomAlert('Error Generating Image', error.message);
        } finally {
            // 7. Hide loading overlay
            overlay.classList.remove('show');
        }
    };

    // ---------- NEW EMAIL + IMAGE GENERATION FUNCTION ----------
window.generateEODAndEmail = async function generateEODAndEmail() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.add('show');

        let payload; // Define payload in the outer scope
        
        try {
            // 1. Get data and create the filled PDF bytes
            payload = await window.collectPayload(); // Assign to outer scope
            const pdfBytes = await createFilledPdfBytes(payload);

            // 2. Load the PDF bytes into pdf.js
            const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
            const pdfDoc = await loadingTask.promise;
            const page = await pdfDoc.getPage(1); // Get the first page

            // 3. Create a canvas to render the PDF
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // 4. Set canvas size with high resolution
            const scale = 2.0;
            const viewport = page.getViewport({ scale: scale });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            // 5. Render the PDF page to the canvas
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;

            // 6. Convert canvas to JPG and DOWNLOAD IT
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9); 
            const a = document.createElement('a');
            const jpgFilename = `EOD Cover Sheet FM${payload.StoreNumberPadded || 'store'} ${payload.DateForFilename || 'date'}.jpg`;
            a.href = dataUrl;
            a.download = jpgFilename;
            document.body.appendChild(a);
            a.click(); // This triggers the save
            document.body.removeChild(a);
            
            // 7. --- START OF MODIFIED CODE ---
            
            // Check the state of the new toggle
            const notesOnly = document.getElementById('notesOnlyToggle').checked;

            // Define the email body based on the toggle
            let body = '';

            if (notesOnly) {
                // If toggle is ON, just add the notes
                body += `

Notes:
  ${payload.Notes || ''}
`;
            } else {
                // If toggle is OFF, add the full report
                body += `

Lead Name:
  ${payload.LeadName || ''}

Date:
  ${payload.DateMMDDYYYY || ''}

Store Number:
  ${payload.StoreNumber || ''}

Did you take a picture of the KOMPASS cart and load it to the KOMPASS Maintenance line in PROD at the start of the shift?
  ${pickYN(payload.BeforePicPosted)}

Manager’s name - who you checked in with:
  ${payload.CheckInManager || ''}

Did you call the KOMPASS Hotline?
  ${pickYN(payload.CalledHotline)}

If so, what commodities?
  ${payload.IssueCommodities || 'N/A'}

What is the issue?
  ${payload.WhatIsIssue || 'N/A'}

Was the issue resolved before EOD?
  ${payload.IssueResolved || 'N/A'}

If not, what was the temporary solution?
  ${payload.TempSolution || 'N/A'}

Manager’s name - who checked out with?
  ${payload.CheckOutManager || ''}

Did all sets get signed out in PROD?
  ${pickYN(payload.SignedOutPROD)}

Did all sets get signed out in SI?
  ${pickYN(payload.SignedOutSI)}

Sign-out sheet attached to the EOD email?
  ${pickYN(payload.SignoutSheetAttachedEmail)}

Sign-out sheet attached to the KOMPASS Maintenance line in PROD?
  ${pickYN(payload.SignoutSheetAttachedPROD)}

Did you take an after picture of the KOMAPSS cart and load it to the KOMPASS Maintenance line in PROD at the end of the shift?
  ${pickYN(payload.AfterPicPosted)}

Notes:
  **${payload.Notes || ''}**
`;
            }
            // --- END OF MODIFIED CODE ---

            const cc = 'MAshabranner@retailodyssey.com,seth.newman@retailodyssey.com,KNix@retailodyssey.com';
            const subject = `EOD FM${payload.StoreNumberPadded} ${payload.DateMMDDYYYY}`;
            
            // Use encodeURIComponent for safety
            const mailtoUrl = `mailto:?cc=${encodeURIComponent(cc)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Hide overlay *before* showing confirm
            overlay.classList.remove('show');

            // Use showCustomConfirm to create the delay and wait for user action
            showCustomConfirm(
                'Image Saved!',
                `Your image has been saved as <b>${jpgFilename}</b>.<br><br>Click 'Yes' to open your email client and attach the file.`,
                () => {
                    // This code runs ONLY when the user clicks "Yes"
                    // Use the new fallback function for desktop Outlook support
                    openEmailClientWithFallback(mailtoUrl, subject, body, cc);
                }
            );
        } catch (error) {
            console.error('Error generating JPG and Email:', error);
            overlay.classList.remove('show'); // Hide overlay on error
            showCustomAlert('Error Generating Email', error.message + (payload ? `<br><br>Debug Info: Store=${payload.StoreNumberPadded}, Date=${payload.DateMMDDYYYY}` : ''));
        }

        // NEW: Helper function to open Outlook/email client with fallback for desktop
        async function openEmailClientWithFallback(mailtoUrl, subject, body, cc) {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                // On mobile, directly use mailto protocol
                window.location.href = mailtoUrl;
                return;
            }

            // On desktop: try mailto: protocol, but with a fallback to clipboard + instructions
            const mailtoAttempt = new Promise((resolve) => {
                // Set a short timeout; if the protocol handler doesn't respond, fall back
                const timer = setTimeout(() => {
                    resolve(false); // mailto protocol likely failed
                }, 1500);

                // Try to open mailto
                window.location.href = mailtoUrl;

                // Check if the window is still in focus (mailto likely worked if user switched to email app)
                window.addEventListener('blur', () => {
                    clearTimeout(timer);
                    resolve(true);
                }, { once: true });
            });

            const success = await mailtoAttempt;

            if (!success) {
                // Fallback: copy body to clipboard and show instructions
                try {
                    await navigator.clipboard.writeText(body);
                    showCustomAlert(
                        'Email Body Copied to Clipboard',
                        `<strong>Mailto protocol not available on this desktop.</strong><br><br>` +
                        `<strong>To:</strong> (Store Manager)<br>` +
                        `<strong>CC:</strong> ${cc}<br><br>` +
                        `<strong>Subject:</strong> ${subject}<br><br>` +
                        `<strong>The email body has been copied to your clipboard.</strong><br>` +
                        `Paste it into your email client and attach the saved JPG file.<br><br>` +
                        `<em>Alternatively, open Outlook and create a new email manually.</em>`
                    );
                } catch (clipErr) {
                    // If clipboard fails too, just show the full email details
                    showCustomAlert(
                        'Manual Email Composition Required',
                        `<strong>To:</strong> (Store Manager)<br>` +
                        `<strong>CC:</strong> ${cc}<br><br>` +
                        `<strong>Subject:</strong> ${subject}<br><br>` +
                        `<strong>Body:</strong><br>${body.substring(0, 200)}...<br><br>` +
                        `Please compose the email manually and attach the saved JPG file.`
                    );
                }
            }
        }
    }
    // --- END EMAIL FALLBACK ---

</script>

</body>
</html>
